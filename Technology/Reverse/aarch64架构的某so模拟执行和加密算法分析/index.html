



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Welcome to coneco's study room" href="https://conecoy.cn/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Welcome to coneco's study room" href="https://conecoy.cn/atom.xml" />
<link rel="alternate" type="application/json" title="Welcome to coneco's study room" href="https://conecoy.cn/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Android,qiling" />


<link rel="canonical" href="https://conecoy.cn/Technology/Reverse/aarch64%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9F%90so%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%92%8C%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/">



  <title>
aarch64架构的某so模拟执行分析 - Reverse - Technology |
Coneco = Welcome to coneco's study room</title>
<meta name="generator" content="Hexo 7.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">aarch64架构的某so模拟执行分析
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-07-16 18:50:07">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-07-16T18:50:07+08:00">2024-07-16</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Coneco</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/20.jpg"></li>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/4.jpg"></li>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/70.jpg"></li>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/47.jpg"></li>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/15.jpg"></li>
          <li class="item" data-background-image="https://image-hosts.oss-cn-chengdu.aliyuncs.com/aokana/45.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Technology/" itemprop="item" rel="index" title="分类于 Technology"><span itemprop="name">Technology</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Technology/Reverse/" itemprop="item" rel="index" title="分类于 Reverse"><span itemprop="name">Reverse</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://conecoy.cn/Technology/Reverse/aarch64%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9F%90so%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%92%8C%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="https://image-hosts.oss-cn-chengdu.aliyuncs.com/others/megumi.jpg">
    <meta itemprop="name" content="coneco">
    <meta itemprop="description" content=", hello, 我是小猫，喜欢逆向、日语、动画、钢琴、羽毛球、乒乓球...。如果有想分享的事，欢迎随便叫上我^_^。">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Welcome to coneco's study room">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h2 id="本文目的"><a href="#本文目的" class="headerlink" title="本文目的"></a>本文目的</h2><p>在用Windows平台使用qiling模拟执行框架中遇到了诸多困难，有些问题并没有查询到解决办法，于是记录此篇文章，希望能给到大家一些参考。</p>
<p>以下列举了本文想阐述的内容点：</p>
<ul>
<li>aarch64 so基于qiling如何做模拟执行</li>
<li>Windows上使用qiling的一些问题解决</li>
<li>算法中虚拟机的模拟执行</li>
</ul>
<blockquote>
<p>本文尽可能从初学者的视角来阐述，初学者可以自行实践。</p>
</blockquote>
<h2 id="分析目标"><a href="#分析目标" class="headerlink" title="分析目标"></a>分析目标</h2><p>最近需要分析一个libxx.so的加密算法，发现是aarch64的so，于是有以下三个思路</p>
<ul>
<li>用IDA静态分析</li>
<li>用调试器调试，跟踪算法流程</li>
<li>用unidbg、unicorn做模拟执行</li>
</ul>
<h2 id="选择模拟执行的原因"><a href="#选择模拟执行的原因" class="headerlink" title="选择模拟执行的原因"></a>选择模拟执行的原因</h2><h3 id="静态分析成本过高"><a href="#静态分析成本过高" class="headerlink" title="静态分析成本过高"></a>静态分析成本过高</h3><p>用IDA看了一下加密函数，有点像嵌套的控制流平坦化，但实际上是一个虚拟机，这样静态分析的难度就提升了不少。<br><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image.png" alt="alt text"></p>
<h3 id="用调试器调试"><a href="#用调试器调试" class="headerlink" title="用调试器调试"></a>用调试器调试</h3><p>最初的想法是编译一个ARM64的可执行文件，然后加载libxx.so，调用加密函数来调试。通过IDA查看字符串信息，发现是ndk+llvm编译的so，给安卓平台使用的。于是想安装一个ARM64的ubuntu虚拟机来调试，但ubuntu似乎没提供ARM64的客户机，只有服务端版本。可能准备其他发行版本的linux（比如centos）可以调试，但想到模拟执行在trace等功能相较于调试器会更好用点，所以最后选择了用模拟器的方式。</p>
<blockquote>
<p>现在想来，可能用Android Studio写个app，然后用lldb来调试可能是最稳定的调试方式。大家有什么其他好的意见呢？</p>
</blockquote>
<h3 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h3><p>unidbg基于unicorn，可以模拟执行安卓的so，能很好的满足需求。但从Bet4的<span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjcyNjA1Lmh0bQ==">这篇文章</span>中，unidbg也存在模拟缺陷，于是我选择了qiling作为模拟执行框架，详细理由可参考上文提及的Bet4的文章。<br>从官方文档了解qiling的大致使用方法后，发现qiling有自带的qdb调试器，不过不支持多线程，而Bet4开源的udbserver支持多线程，配合pwndbg效果图如下（图来自Bet4的帖子）：<br><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/pwndbg.png" alt="alt text"><br>之后又发现qiling提供了IDA插件，方便直接在IDA中模拟执行so。因为分析算法会经常参考IDA的一些视图，如果用udbserver的话，会在gdb调试器和IDA之间频繁切换，最后我选择使用qiling的IDA插件来“可视化地调试so”。</p>
<h2 id="ARM64-demo运行"><a href="#ARM64-demo运行" class="headerlink" title="ARM64 demo运行"></a>ARM64 demo运行</h2><p>在qiling源码的examples\rootfs\arm64_linux\bin目录下，有很多arm64程序可供模拟执行，lib目录下包含了程序对应的动态链接器，ARM64对应的动态链接器一般是ld-linux-aarch64.so.1。这个动态链接器非常关键，它负责程序依赖的库的加载和程序自身的重定位等功能。</p>
<p>接下来拿bin目录下的arm64_hello举例，演示如何用IDA插件来模拟执行一个aarch64的so，arm64_hello的功能是输出“Hello, World!”字符串，然后退出。官网的完整demo可查看<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnFpbGluZy5pby9lbi9sYXRlc3QvaWRhLw==">这个链接</span>。</p>
<h3 id="初始化qiling环境"><a href="#初始化qiling环境" class="headerlink" title="初始化qiling环境"></a>初始化qiling环境</h3><p>用IDA加载arm64_hello，选择”File-&gt;Script file…”加载qiling\extensions\idaplugin\qilingida.py。</p>
<blockquote>
<p>在我的电脑上软连接无法生效，可能qiling只测试了Linux，所以这里直接用IDA加载脚本的方式来加载qilingida.py。</p>
</blockquote>
<p>然后在IDA汇编视图右键-&gt;Qiling Emulator-&gt;Setup（后续简称<code>Qiling-&gt;</code>），加载IDA插件，这里使用qiling默认的辅助脚本（custom_script.py）。在IDA中的一些自动化逻辑都可以放到该脚本中，比如添加一些syscall或者针对某地址的hook到该辅助脚本，之后会举例脚本的用法。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240716201551107.png" alt="image-20240716201551107"></p>
<p>俗话说万事开头难，运行demo就出现加载失败了，如下：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\l</span>inux.py&quot;</span>, line <span class="number">30</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    super(QlOsLinux, self).__init__(ql)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\p</span>osix<span class="char escape_">\p</span>osix.py&quot;</span>, line <span class="number">190</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    super().__init__(ql)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\o</span>s.py&quot;</span>, line <span class="number">63</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    sys.stdin.fileno()</span><br><span class="line"><span class="params">AttributeError:</span> &#x27;NoneType&#x27; object has no attribute &#x27;fileno&#x27;</span><br></pre></td></tr></table></figure>

<p>观察os.py的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Qiling may be used on interactive shells (ex: IDLE) or embedded python</span></span><br><span class="line">            <span class="comment"># interpreters (ex: IDA Python). such environments use their own version</span></span><br><span class="line">            <span class="comment"># for the standard streams which usually do not support certain operations,</span></span><br><span class="line">            <span class="comment"># such as fileno(). here we use this to determine how we are going to use</span></span><br><span class="line">            <span class="comment"># the environment standard streams</span></span><br><span class="line">            sys.stdin.fileno()</span><br><span class="line">        <span class="keyword">except</span> UnsupportedOperation:</span><br><span class="line">            <span class="comment"># Qiling is used on an interactive shell or embedded python interpreter.</span></span><br><span class="line">            <span class="comment"># if the internal stream buffer is accessible, we should use it</span></span><br><span class="line">            <span class="variable language_">self</span>._stdin  = <span class="built_in">getattr</span>(sys.stdin,  <span class="string">&#x27;buffer&#x27;</span>, sys.stdin)</span><br><span class="line">            <span class="variable language_">self</span>._stdout = <span class="built_in">getattr</span>(sys.stdout, <span class="string">&#x27;buffer&#x27;</span>, sys.stdout)</span><br><span class="line">            <span class="variable language_">self</span>._stderr = <span class="built_in">getattr</span>(sys.stderr, <span class="string">&#x27;buffer&#x27;</span>, sys.stderr)</span><br></pre></td></tr></table></figure>

<p>报错提示sys.stdin为None，这是因为IDA修改了sys.stdin，使用了自己的输入输出流。这个问题在qiling的github issues，pull request都有提到，我这里直接捕获AttributeError异常，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">except</span> (UnsupportedOperation, AttributeError):</span><br></pre></td></tr></table></figure>

<p>修复之后，重启IDA加载qiling环境（python安装的qiling环境），Qiling-&gt;Setup，报错如下：</p>
<blockquote>
<p>这里修复的os.py文件是python库下的qiling，也就是C:\Program Files\Python39\lib\site-packages\qiling\os\os.py。</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  File &quot;E:\gitRepo\qiling\examples\extensions\idaplugin\custom_script.py&quot;, <span class="type">line</span> <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="keyword">from</span> future <span class="keyword">import</span> __annotations__</span><br><span class="line">ImportError: cannot <span class="keyword">import</span> <span class="type">name</span> <span class="string">&#x27;__annotations__&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;future&#x27;</span> (C:\Program Files\Python39\lib\site-packages\future\__init__.py)</span><br><span class="line">[<span class="keyword">INFO</span>][(<span class="type">unknown</span> file):<span class="number">0</span>] Custom <span class="keyword">user</span> script <span class="keyword">not</span> <span class="built_in">found</span>.</span><br></pre></td></tr></table></figure>

<p>这里我使用的python版本是3.9.13，大致查了一下，python库有__future__，没有future，不知道与python版本是否有关，改成如下形式，再次加载就成功了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br></pre></td></tr></table></figure>

<h3 id="开始模拟执行"><a href="#开始模拟执行" class="headerlink" title="开始模拟执行"></a>开始模拟执行</h3><p>现在，arm64_hello已加载进内存，动态链接器需要修复重定位表、设置程序入口点等，然后开始运行。</p>
<blockquote>
<blockquote>
<p>阅读qiling\os\linux.py的QlOsLinux::run方法，由于当前是单线程环境，且没有显式指定运行的起始地址，因此程序的起始地址是动态链接器的入口点，待动态链接器初始化后，将跳转到程序的真正入口点：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	<span class="comment"># 如果是一段二进制代码</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.ql.code:</span><br><span class="line">        <span class="variable language_">self</span>.ql.emu_start(<span class="variable language_">self</span>.entry_point, (<span class="variable language_">self</span>.entry_point + <span class="built_in">len</span>(<span class="variable language_">self</span>.ql.code)), <span class="variable language_">self</span>.ql.timeout, <span class="variable language_">self</span>.ql.count)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 如果是多线程环境</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.ql.multithread:</span><br><span class="line">            <span class="comment"># start multithreading</span></span><br><span class="line">            thread_management = thread.QlLinuxThreadManagement(<span class="variable language_">self</span>.ql)</span><br><span class="line">            <span class="variable language_">self</span>.ql.os.thread_management = thread_management</span><br><span class="line">            thread_management.run()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 不是多线程环境</span></span><br><span class="line">            <span class="comment"># 程序入口点是否有显式指定</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.ql.entry_point <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.ql.loader.elf_entry = <span class="variable language_">self</span>.ql.entry_point</span><br><span class="line"></span><br><span class="line">            <span class="comment"># do we have an interp?</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="variable language_">self</span>.ql.loader.elf_entry != <span class="variable language_">self</span>.ql.loader.entry_point:</span><br><span class="line">                entry_address = <span class="variable language_">self</span>.ql.loader.elf_entry</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.ql.arch.<span class="built_in">type</span> == QL_ARCH.ARM:</span><br><span class="line">                    entry_address &amp;= ~<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># start running interp, but stop when elf entry point is reached</span></span><br><span class="line">                <span class="variable language_">self</span>.ql.emu_start(<span class="variable language_">self</span>.ql.loader.entry_point, entry_address, <span class="variable language_">self</span>.ql.timeout)</span><br><span class="line">                <span class="variable language_">self</span>.ql.do_lib_patch()</span><br><span class="line">                <span class="variable language_">self</span>.run_function_after_load()</span><br><span class="line">                <span class="variable language_">self</span>.ql.loader.skip_exit_check = <span class="literal">False</span></span><br><span class="line">                <span class="variable language_">self</span>.ql.write_exit_trap()</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.ql.emu_start(<span class="variable language_">self</span>.ql.loader.elf_entry, <span class="variable language_">self</span>.exit_point, <span class="variable language_">self</span>.ql.timeout, <span class="variable language_">self</span>.ql.count)</span><br></pre></td></tr></table></figure></blockquote>
</blockquote>
<p>IDA汇编视图右键-&gt;Qiling Emulator-&gt;Continue开始模拟执行，报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[+] 	brk: increasing program <span class="keyword">break</span> <span class="keyword">from</span> <span class="number">0x555555568000</span> to <span class="number">0x555555589000</span></span><br><span class="line">[+] 	<span class="number">0x00007fffb7e9e93c</span>: brk(inp = <span class="number">0x555555589000</span>) = <span class="number">0x555555589000</span></span><br><span class="line">[+] 	Received interrupt: <span class="number">0x2</span></span><br><span class="line">[+] 	write() CONTENT: <span class="string">b&#x27;Hello, World!\n&#x27;</span></span><br><span class="line">[x] 	Syscall ERROR: ql_syscall_write DEBUG: A string expected</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">File <span class="string">&quot;C:\Program Files\Python39\lib\site-packages\qiling\os\posix\syscall\unistd.py&quot;</span>, line <span class="number">410</span>, <span class="keyword">in</span> ql_syscall_write</span><br><span class="line">    f.write(data)</span><br><span class="line">  File <span class="string">&quot;D:\Tools\IDA 7.5\python\3\init.py&quot;</span>, line <span class="number">63</span>, <span class="keyword">in</span> write</span><br><span class="line">    ida_kernwin.msg(text)</span><br><span class="line">  File <span class="string">&quot;D:\Tools\IDA 7.5\python\3\ida_kernwin.py&quot;</span>, line <span class="number">236</span>, <span class="keyword">in</span> msg</span><br><span class="line">    <span class="keyword">return</span> _ida_kernwin.msg(*args)</span><br><span class="line">TypeError: A string expected</span><br></pre></td></tr></table></figure>

<p>这里看到已经成功执行puts函数，打印了“Hello, World”，当把这个字符串传给python打印时，出现异常，原因是qiling传给ida_kernwin.msg方法的类型是字节字符串，不是字符串。</p>
<p>解决办法有两个：</p>
<ul>
<li>直接改D:\Tools\IDA 7.5\python\3\ida_kernwin.py的源码，兼容字节字符串</li>
<li>hook write函数，替换掉qiling自己的ql_syscall_write</li>
</ul>
<p>第一种方法由于是全局的，会影响到其他二进制文件的分析，且hook系统函数是qiling自身的功能，所以使用第二种方法。</p>
<p>修改custom_script.py，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_syscall_write</span>(<span class="params">ql: Qiling, fd: <span class="built_in">int</span>, buf: <span class="built_in">int</span>, count: <span class="built_in">int</span></span>):</span><br><span class="line">    ql.log.info(<span class="string">&#x27;my_syscall_write called&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># read data from emulated memory</span></span><br><span class="line">        data = ql.mem.read(buf, count)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># select the emulated file object that corresponds to the requested</span></span><br><span class="line">        <span class="comment"># file descriptor</span></span><br><span class="line">        fobj = ql.os.fd[fd]</span><br><span class="line">        <span class="keyword">if</span> fobj == <span class="literal">None</span>:</span><br><span class="line">            ql.log.ingo(<span class="string">&#x27;none file descriptor&#x27;</span>)</span><br><span class="line">        <span class="comment"># write the data into the file object, if it supports write operations</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(fobj, <span class="string">&#x27;write&#x27;</span>):</span><br><span class="line">            fobj.write(data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        ret = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ret = count</span><br><span class="line"></span><br><span class="line">    ql.log.info(<span class="string">f&#x27;my_syscall_write(<span class="subst">&#123;fd&#125;</span>, <span class="subst">&#123;buf:#x&#125;</span>, <span class="subst">&#123;count&#125;</span>) = <span class="subst">&#123;ret&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QILING_IDA</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_show_context</span>(<span class="params">self, ql: Qiling</span>):</span><br><span class="line">        registers = <span class="built_in">tuple</span>(ql.arch.regs.register_mapping.keys())</span><br><span class="line">        grouping = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(registers), grouping):</span><br><span class="line">            ql.log.info(<span class="string">&#x27;\t&#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;r:5s&#125;</span>: <span class="subst">&#123;ql.arch.regs.read(r):016x&#125;</span>&#x27;</span> <span class="keyword">for</span> r <span class="keyword">in</span> registers[idx:idx + grouping]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">custom_prepare</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        ql.log.info(<span class="string">&#x27;Context before starting emulation:&#x27;</span>)</span><br><span class="line">        ql.os.set_syscall(<span class="string">&#x27;write&#x27;</span>, my_syscall_write)</span><br><span class="line">        ql.log.info(<span class="string">&#x27;my_syscall_write registered&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>._show_context(ql)</span><br></pre></td></tr></table></figure>

<p>这里实现了一个my_syscall_write函数，然后在QILING_IDA类的custom_prepare方法中调用ql.os.set_syscall来注册write的syscall。</p>
<p>修改custom_script后右键-&gt;Qiling Emulator-&gt;Reload User Scripts（后续简称Qiling菜单）就会重新加载脚本，最后在Qiling菜单点击<code>Restart</code>，重新开始运行，结果正常，打印出了“Hello, World!”。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[+]</span> 	Received <span class="built_in">int</span>errupt: <span class="number">0x2</span></span><br><span class="line"><span class="string">[=]</span> 	my_syscall_write called</span><br><span class="line">Hello, World!</span><br><span class="line"><span class="string">[=]</span> 	my_syscall_write(<span class="number">1</span>, <span class="number">0x555555568260</span>, <span class="number">14</span>) = <span class="number">14</span></span><br><span class="line"><span class="string">[+]</span> 	<span class="number">0x00007fffb7e98afc</span>: my_syscall_write(fd = <span class="number">0x1</span>, buf = <span class="number">0x555555568260</span>, count = <span class="number">0xe</span>) = <span class="number">0xe</span></span><br><span class="line"><span class="string">[+]</span> 	Received <span class="built_in">int</span>errupt: <span class="number">0x2</span></span><br><span class="line"><span class="string">[+]</span> 	<span class="number">0x00007fffb7e78a2c</span>: exit_group(code = <span class="number">0x0</span>) = ?</span><br></pre></td></tr></table></figure>

<h3 id="通过显式设置PC寄存器指定程序执行入口"><a href="#通过显式设置PC寄存器指定程序执行入口" class="headerlink" title="通过显式设置PC寄存器指定程序执行入口"></a>通过显式设置PC寄存器指定程序执行入口</h3><p>上节跑通了Qiling-&gt;Continue，现在尝试Qiling菜单的“设置运行地址”。</p>
<p>首先Qiling-&gt;Restart，在IDA里对__libc_start_main函数下断点，Qiling-&gt;Continue。此时会看到成功地断在了这里：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717103851651.png" alt="image-20240717103851651"></p>
<p>Qiling-&gt;View Register，查看PC寄存器，确认地址是否一致。这里发现PC的值是0x5E0+程序基址。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717103902110.png" alt="image-20240717103902110"></p>
<p>可以Qiling-&gt;Step，单步几次，会看到IDA中的不同颜色，这些颜色代表不同的执行操作。蓝色是单步，绿色的直接运行覆盖的路径。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717103807022.png" alt="image-20240717103807022"></p>
<p>sub_724函数是真正的打印函数，将光标移到sub_724的第一条指令，Qiling-&gt;Set PC，此时打印：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">INFO</span>][(unknown file):0] QIling PC <span class="built_in">set</span> <span class="keyword">to</span> 0x724</span><br></pre></td></tr></table></figure>

<p>看到设置好了PC后，继续Qiling-&gt;Continue，结果报错：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[x] 	CPU <span class="params">Context:</span></span><br><span class="line">[x] 	<span class="params">x0	:</span> <span class="number">0</span>x555555554724</span><br><span class="line">[x] 	<span class="params">x1	:</span> <span class="number">0</span>x1</span><br><span class="line">[x] 	<span class="params">x2	:</span> <span class="number">0</span>x80000000de18</span><br><span class="line">...</span><br><span class="line">[x] 	PC <span class="operator">=</span> <span class="number">0</span>x0000000000000724 (unreachable)</span><br><span class="line">...</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\c</span>ore.py&quot;</span>, line <span class="number">771</span>, <span class="keyword">in</span> emu_start</span><br><span class="line">    self.uc.emu_start(begin, end, timeout, count)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\u</span>nicorn<span class="char escape_">\u</span>nicorn.py&quot;</span>, line <span class="number">547</span>, <span class="keyword">in</span> emu_start</span><br><span class="line">    raise UcError(status)</span><br><span class="line">unicorn.unicorn.<span class="params">UcError:</span> Invalid memory fetch (UC_ERR_FETCH_UNMAPPED)</span><br></pre></td></tr></table></figure>

<p>错误提示PC为0x724的代码是无法访问的，看寄存器：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717104752266.png" alt="image-20240717104752266"></p>
<p>这里的PC是0x724，回想之前看Qiling寄存器是 IDA地址 + 基址的形式，于是知道原因是Qiling-&gt;Set PC设置的是IDA地址，没有加上模块基址。</p>
<p>修改qiling的IDA插件,qilingida.py如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_set_pc</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.qlinit:</span><br><span class="line">        <span class="comment"># ea = IDA.get_current_address()</span></span><br><span class="line">        ea = <span class="variable language_">self</span>.qlemu.ql_addr_from_ida(IDA.get_current_address())</span><br><span class="line">        <span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc = ea</span><br><span class="line">        logging.info(<span class="string">f&quot;QIling PC set to <span class="subst">&#123;<span class="built_in">hex</span>(ea)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.qlemu.status = <span class="variable language_">self</span>.qlemu.ql.save()</span><br><span class="line">        <span class="variable language_">self</span>.ql_update_views(<span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc, <span class="variable language_">self</span>.qlemu.ql)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;Qiling should be setup firstly.&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>IDA插件更新后，先”Qiling-&gt;Unload Plugin”卸载插件，再IDA-&gt;File-&gt;Script file加载插件，然后重新操作一遍，这次设置PC就添上基址了：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">INFO</span>][(unknown file):0] QIling PC <span class="built_in">set</span> <span class="keyword">to</span> 0x555555554724</span><br></pre></td></tr></table></figure>

<p>最后，移动光标，点击sub_724的最后一条指令，然后Qiling-&gt;Execute Till，会看到这次成功执行，橙色代表Execute Till执行过的指令：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717110923042.png" alt="image-20240717110923042"></p>
<p>可以看到下一条指令就是0x748：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717111000909.png" alt="image-20240717111000909"></p>
<h3 id="小节"><a href="#小节" class="headerlink" title="小节"></a>小节</h3><p>从这里可以看到，qiling的IDA插件其实还不完善，即使是官方的dev分支（官方推荐使用dev分支），模拟执行demo还是有很多问题，所以对初学者不算非常友好。因此这里记录下相关问题的解决建议，供大家参考，后文还会有稍麻烦的bug需要解决。</p>
<h2 id="libxx-so的模拟执行（排错）"><a href="#libxx-so的模拟执行（排错）" class="headerlink" title="libxx.so的模拟执行（排错）"></a>libxx.so的模拟执行（排错）</h2><p>OK，demo已经跑通了，现在来模拟执行libxx.so。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717111824127.png" alt="image-20240717111824127"></p>
<p>可以看到算法的核心几个步骤是init，encrypt，decrypt。那么首先分析tps_init函数。</p>
<blockquote>
<p>加载libxx.so、初始化qiling后，不能直接将PC寄存器指向tps_init函数，因为这时运行环境还没有准备好，比如tpidr_el0寄存器，这个寄存器类似与windows的fs段寄存器（TEB），指向当前线程的运行环境。另外，此时还没有做so的重定位，很多so里的全局引用是需要重定位的，比如调用一个memset函数。</p>
</blockquote>
<p>首先IDA加载libxx.so，初始化qiling（Qiling-&gt;Setup），对libxx.so的入口地址（start函数）下断点，然后开始模拟执行（Qiling-&gt;Continue），报错：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[x] 	Syscall <span class="params">ERROR:</span> ql_syscall_futex <span class="params">DEBUG:</span> &#x27;NoneType&#x27; object has no attribute &#x27;cur_thread&#x27;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\p</span>osix<span class="char escape_">\p</span>osix.py&quot;</span>, line <span class="number">374</span>, <span class="keyword">in</span> load_syscall</span><br><span class="line">    <span class="attr">retval</span> <span class="operator">=</span> syscall_hook(self.ql, <span class="operator">*</span>params)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\p</span>osix<span class="char escape_">\s</span>yscall<span class="char escape_">\f</span>utex.py&quot;</span>, line <span class="number">43</span>, <span class="keyword">in</span> ql_syscall_futex</span><br><span class="line">    <span class="attr">regreturn</span> <span class="operator">=</span> ql.os.futexm.futex_wake(ql, uaddr,ql.os.thread_management.cur_thread, val)</span><br><span class="line"><span class="params">AttributeError:</span> &#x27;NoneType&#x27; object has no attribute &#x27;cur_thread&#x27;</span><br></pre></td></tr></table></figure>

<p>查看源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> op &amp; (FUTEX_PRIVATE_FLAG - <span class="number">1</span>) == FUTEX_WAKE:</span><br><span class="line">        regreturn = ql.os.futexm.futex_wake(ql, uaddr,ql.os.thread_management.cur_thread, val)</span><br></pre></td></tr></table></figure>

<p>futex是linux中的锁，这里的thread_management是需要qiling启动多线程模式才会初始化的，于是在qilingida.py创建Qiling实例的时候添加多线程参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">QlEmuQiling</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.path = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.rootfs = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.ql: Qiling = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.status = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.exit_addr = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.baseaddr = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.env = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="variable language_">self</span>.ql = Qiling(argv=<span class="variable language_">self</span>.path, rootfs=<span class="variable language_">self</span>.rootfs, verbose=QL_VERBOSE.DEFAULT, multithread=<span class="literal">True</span>, env=<span class="variable language_">self</span>.env, log_plain=<span class="literal">True</span>, *args, **kwargs)</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>这里日志打印从QL_VERBOSE.DEBUG改为QL_VERBOSE.DEFAULT，减少一些调试内容的输出，然后multithread显式打开。再卸载、加载一次qilingida.py，重新运行，以下报错：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[x] [Thread <span class="number">2000</span>]	Syscall <span class="params">ERROR:</span> ql_syscall_writev <span class="params">DEBUG:</span> A string expected</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\p</span>osix<span class="char escape_">\p</span>osix.py&quot;</span>, line <span class="number">374</span>, <span class="keyword">in</span> load_syscall</span><br><span class="line">    <span class="attr">retval</span> <span class="operator">=</span> syscall_hook(self.ql, <span class="operator">*</span>params)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\p</span>osix<span class="char escape_">\s</span>yscall<span class="char escape_">\u</span>io.py&quot;</span>, line <span class="number">23</span>, <span class="keyword">in</span> ql_syscall_writev</span><br><span class="line">    ql.os.fd[fd].write(buf)</span><br><span class="line">  File <span class="string">&quot;D:<span class="char escape_">\T</span>ools<span class="char escape_">\I</span>DA 7.5<span class="char escape_">\p</span>ython<span class="char escape_">\3</span><span class="char escape_">\i</span>nit.py&quot;</span>, line <span class="number">63</span>, <span class="keyword">in</span> write</span><br><span class="line">    ida_kernwin.msg(text)</span><br><span class="line">  File <span class="string">&quot;D:<span class="char escape_">\T</span>ools<span class="char escape_">\I</span>DA 7.5<span class="char escape_">\p</span>ython<span class="char escape_">\3</span><span class="char escape_">\i</span>da_kernwin.py&quot;</span>, line <span class="number">236</span>, <span class="keyword">in</span> msg</span><br><span class="line">    return _ida_kernwin.msg(<span class="operator">*</span>args)</span><br><span class="line"><span class="params">TypeError:</span> A string expected</span><br></pre></td></tr></table></figure>

<p>这个和之前demo的问题一样，只是这次的syscall是writev，不是write。在custom_script.py添加writev的syscall hook，定义my_syscall_writev函数，Qiling-&gt;Reload User Script重新加载自定义脚本，重启qiling环境运行，这次成功运行到start函数：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717140048966.png" alt="image-20240717140048966"></p>
<p>但注意tpidr_el0为0，代表线程运行环境没有准备好。如果这时直接Qiling-&gt;continue，还会出现另一个报错：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">PC</span> = <span class="number">0x000000000009aec0</span> (unreachable)</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">Memory</span> map:</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">Start</span>            <span class="symbol">End</span>              <span class="symbol">Perm</span>    <span class="symbol">Label</span>        <span class="symbol">Image</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">00555555554000</span> - <span class="number">00555555847000</span>   r-x     libxx.so     <span class="symbol">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\bin\libxx.so</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">00555555856000</span> - <span class="number">0055555588</span>f000   rw-     libxx.so     <span class="symbol">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\bin\libxx.so</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">0055555588</span>f000 - <span class="number">00555555891000</span>   rwx     [hook_mem]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>ffffffde000 - <span class="number">0080000000e000</span>   rwx     [stack]      </span><br><span class="line"><span class="symbol">Traceback</span> (most recent call last):</span><br><span class="line">...</span><br><span class="line">  <span class="symbol">File</span> <span class="string">&quot;C:\Program Files\Python39\lib\site-packages\unicorn\unicorn.py&quot;</span>, line <span class="number">547</span>, in emu_start</span><br><span class="line">    raise <span class="symbol">UcError</span>(status)</span><br><span class="line">unicorn.unicorn.<span class="symbol">UcError</span>: <span class="symbol">Invalid</span> memory fetch (<span class="symbol">UC_ERR_FETCH_UNMAPPED</span>)</span><br></pre></td></tr></table></figure>

<p>这里可以看到，PC准备执行0x9aec0处的指令，但从打印的内存映射来看，0x9aec0是没有映射的，所以导致指令读取失败。</p>
<p>再更仔细地看内存映射信息，发现没有动态链接器加载到内存空间，用readelf看一下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$ readelf -S libxx.so | grep interp</span></span><br><span class="line"><span class="section">---</span></span><br><span class="line">$ readelf -S arm64_hello | grep interp</span><br><span class="line"><span class="code">  [ 1] .interp           PROGBITS         0000000000000200  00000200</span></span><br></pre></td></tr></table></figure>

<p>libxx.so没有interp节，而arm64_hello有，所以qiling在加载libxx.so的时候没有加载动态链接器。</p>
<p>那现在需要给libxx.so显示指定动态链接器，为确定在哪指定，先打开debug级别的日志输出：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def start(self, <span class="number">*a</span>rgs, **kwargs):</span><br><span class="line">    self.ql = Qiling(<span class="attribute">argv</span>=self.path, <span class="attribute">rootfs</span>=self.rootfs, <span class="attribute">verbose</span>=QL_VERBOSE.DEBUG, <span class="attribute">multithread</span>=<span class="literal">True</span>, <span class="attribute">env</span>=self.env, <span class="attribute">log_plain</span>=<span class="literal">True</span>, <span class="number">*a</span>rgs, **kwargs)</span><br></pre></td></tr></table></figure>

<p>重新加载qilingida.py，初始化qiling环境，结果没有相关输出。再用IDA打开arm64_hello，相关输出如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[INFO]</span><span class="selector-attr">[qilingida:1034]</span> Custom env: &#123;&#125;</span><br><span class="line"><span class="selector-attr">[+]</span> 	Profile: default</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x555555554000-<span class="number">0</span>x555555555000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x555555564000-<span class="number">0</span>x555555566000</span><br><span class="line"><span class="selector-attr">[+]</span> 	mem_start : <span class="number">0</span>x555555554000</span><br><span class="line"><span class="selector-attr">[+]</span> 	mem_end   : <span class="number">0</span>x555555566000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Interpreter <span class="selector-tag">path</span>: /lib/ld-linux-aarch64<span class="selector-class">.so</span>.<span class="number">1</span></span><br><span class="line"><span class="selector-attr">[+]</span> 	Interpreter addr: <span class="number">0</span>x7ffff7dd5000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x7ffff7dd5000-<span class="number">0</span>x7ffff7df2000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x7ffff7e01000-<span class="number">0</span>x7ffff7e04000</span><br><span class="line"><span class="selector-attr">[+]</span> 	mmap_address is : <span class="number">0</span>x7fffb7dd6000</span><br></pre></td></tr></table></figure>

<p>看到arm64_hello的动态链接器是&#x2F;lib&#x2F;ld-linux-aarch64.so.1，根据这个打印日志，去qiling源码查找：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_with_ld</span>()</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">load_elf_segments</span>()</span><br><span class="line">    	<span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># determine interpreter path</span></span><br><span class="line">        interp_seg = <span class="built_in">next</span>(elffile.iter_segments(<span class="built_in">type</span>=<span class="string">&#x27;PT_INTERP&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">        interp_path = <span class="built_in">str</span>(interp_seg.get_interp_name()) <span class="keyword">if</span> interp_seg <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的interp_path为动态链接器的路径，所以显示指定如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(interp_path) == <span class="number">0</span>:</span><br><span class="line">    interp_path = <span class="string">&quot;/lib/ld-linux-aarch64.so.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>重启qiling环境，可看到动态链接器的加载：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[INFO]</span><span class="selector-attr">[qilingida:1034]</span> Custom env: &#123;&#125;</span><br><span class="line"><span class="selector-attr">[+]</span> 	Profile: default</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x555555554000-<span class="number">0</span>x555555847000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x555555856000-<span class="number">0</span>x55555588f000</span><br><span class="line"><span class="selector-attr">[+]</span> 	mem_start : <span class="number">0</span>x555555554000</span><br><span class="line"><span class="selector-attr">[+]</span> 	mem_end   : <span class="number">0</span>x55555588f000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Interpreter <span class="selector-tag">path</span>: /lib/ld-linux-aarch64<span class="selector-class">.so</span>.<span class="number">1</span></span><br><span class="line"><span class="selector-attr">[+]</span> 	Interpreter addr: <span class="number">0</span>x7ffff7dd5000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x7ffff7dd5000-<span class="number">0</span>x7ffff7df2000</span><br><span class="line"><span class="selector-attr">[+]</span> 	Mapped <span class="number">0</span>x7ffff7e01000-<span class="number">0</span>x7ffff7e04000</span><br></pre></td></tr></table></figure>

<p>然后开始qiling的模拟执行（Qiling-&gt;Continue），如下报错：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;Inconsistency detected by ld.<span class="params">so:</span> &#x27;</span><br><span class="line">Inconsistency detected by ld.<span class="params">so:</span> [<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;rtld.c&#x27;</span><br><span class="line">rtld.c[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	<span class="params">b&#x27;:</span> &#x27;</span><br><span class="line">: [<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;<span class="number">1266</span>&#x27;</span><br><span class="line"><span class="number">1266</span>[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	<span class="params">b&#x27;:</span> &#x27;</span><br><span class="line">: [<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;dl_main&#x27;</span><br><span class="line">dl_main[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	<span class="params">b&#x27;:</span> &#x27;</span><br><span class="line">: [<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;Assertion `&#x27;</span><br><span class="line">Assertion `[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b&#x27;GL(dl_rtld_map).l_libname&#x27;</span><br><span class="line">GL(dl_rtld_map).l_libname[<span class="operator">+</span>] [Thread <span class="number">2000</span>]	b<span class="string">&quot;&#x27; failed!<span class="char escape_">\n</span>&quot;</span></span><br><span class="line">&#x27; failed<span class="operator">!</span></span><br><span class="line">...</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\l</span>inux.py&quot;</span>, line <span class="number">167</span>, <span class="keyword">in</span> run</span><br><span class="line">    thread_management.run()</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">613</span>, <span class="keyword">in</span> run</span><br><span class="line">    <span class="attr">previous_thread</span> <span class="operator">=</span> self._prepare_lib_patch()</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">593</span>, <span class="keyword">in</span> _prepare_lib_patch</span><br><span class="line">    raise QlErrorExecutionStop(&#x27;Dynamic library .init() failed<span class="operator">!</span>&#x27;)</span><br><span class="line">qiling.exception.<span class="params">QlErrorExecutionStop:</span> Dynamic library .init() failed<span class="operator">!</span></span><br></pre></td></tr></table></figure>

<p>第一句话直接提示了该动态链接器不兼容当前so。想起这个so是通过ndk编译给安卓用的，那动态链接器应该是安卓下的linker64。</p>
<p>Bet4从qiling的github fork了仓库，里面有linker64和安卓下所需的其他so，比如libz、libm、liblog。</p>
<p>用readelf看到libxx.so引用了这些库，所以这里一并准备好，路径如下：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d libxx.so</span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0</span>x311f88 contains <span class="number">29</span> entries:</span><br><span class="line">  Tag        <span class="keyword">Type</span>                         Name/Value</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [liblog.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [libz.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [libm.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [libdl.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000001 (NEEDED)             <span class="keyword">Shared</span> <span class="keyword">library</span>: [libc.so]</span><br><span class="line"> <span class="number">0</span>x000000000000000e (SONAME)             <span class="keyword">Library</span> soname: [libtps.so]</span><br><span class="line"> <span class="number">0</span>x0000000000000019 (INIT_ARRAY)         <span class="number">0</span>x302dc0</span><br><span class="line"> <span class="number">0</span>x000000000000001b (INIT_ARRAYSZ)       <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0</span>x000000000000001a (FINI_ARRAY)         <span class="number">0</span>x302dc8</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\system\lib64：保存libm.so等库</span><br><span class="line"><span class="name">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\lib：保存linker64</span><br></pre></td></tr></table></figure>

<p>该动态链接器更换为linker64后，重启IDA，初始化qiling环境，Qiling-&gt;Continue，出现以下报错：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[x] [Thread <span class="number">2000</span>]	<span class="params">Disassembly:</span></span><br><span class="line">[<span class="operator">=</span>] [Thread <span class="number">2000</span>]	<span class="number">00007</span>ffff7ddfbd0 [linker64             <span class="operator">+</span> <span class="number">0</span>x00abd0]  <span class="number">9</span>c <span class="number">20</span> <span class="number">40</span> <span class="number">79</span>          ldrh                 w28, [x4, <span class="comment">#0x10]</span></span><br><span class="line">[<span class="operator">=</span>] [Thread <span class="number">2000</span>]	<span class="number">00007</span>ffff7ddfbd4 [linker64             <span class="operator">+</span> <span class="number">0</span>x00abd4]  <span class="number">9</span>f <span class="number">0</span>f <span class="number">00</span> <span class="number">71</span>          cmp                  w28, <span class="comment">#3</span></span><br><span class="line">[<span class="operator">=</span>] [Thread <span class="number">2000</span>]	<span class="number">00007</span>ffff7ddfbd8 [linker64             <span class="operator">+</span> <span class="number">0</span>x00abd8]  <span class="number">81</span> <span class="number">34</span> <span class="number">00</span> <span class="number">54</span>          b.ne                 <span class="comment">#0x7ffff7de0268</span></span><br><span class="line">...</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\c</span>ore.py&quot;</span>, line <span class="number">771</span>, <span class="keyword">in</span> emu_start</span><br><span class="line">    self.uc.emu_start(begin, end, timeout, count)</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\u</span>nicorn<span class="char escape_">\u</span>nicorn.py&quot;</span>, line <span class="number">547</span>, <span class="keyword">in</span> emu_start</span><br><span class="line">    raise UcError(status)</span><br><span class="line">unicorn.unicorn.<span class="params">UcError:</span> Invalid memory read (UC_ERR_READ_UNMAPPED)</span><br></pre></td></tr></table></figure>

<p>此时X4为0，导致了内存访问异常。用IDA打开linker64，崩溃点如下：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717150000658.png" alt="image-20240717150000658"></p>
<p>大致看了上下文，该函数是_dl___linker_init，用来初始化动态库so，要知道X4为什么是0还得往上回溯，需要一点时间。且这个linker64是安卓低版本6.0，可能有不兼容的地方，于是我想尝试另外的linker64，正好手上有一台PIXEL，于是把里面的linker64复制出来，再测试一次，结果如下：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+] [<span class="symbol">Thread</span> <span class="number">2001</span>]	b<span class="string">&#x27;libc&#x27;</span></span><br><span class="line">libc[+] [<span class="symbol">Thread</span> <span class="number">2001</span>]	b<span class="string">&#x27;: &#x27;</span></span><br><span class="line">: [+] [<span class="symbol">Thread</span> <span class="number">2001</span>]	b<span class="string">&#x27;unable to stat &quot;/proc/self/exe&quot;: Operation not permitted&#x27;</span></span><br><span class="line">unable to stat <span class="string">&quot;/proc/self/exe&quot;</span>: <span class="symbol">Operation</span> not permitted[+] [<span class="symbol">Thread</span> <span class="number">2001</span>]	b<span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>报错无法读取&#x2F;proc&#x2F;self&#x2F;exe，这是一个符号链接，linker64用它来获取自身的绝对路径，linker伪代码如下：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717210638992.png" alt="image-20240717210638992"></p>
<p>这里用qiling hook 0x27DA8地址，然后返回绝对路径和长度，更新custom_script.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">custom_continue</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="type">List</span>[HookRet]:</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addr_27DA8_hook</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        ql.arch.regs.W0 = <span class="number">0</span></span><br><span class="line">        ql.arch.regs.PC += <span class="number">4</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">return</span> [ql.hook_address(addr_27DA8_hook, <span class="number">0x27DA8</span>+linker_baseaddr)]</span><br></pre></td></tr></table></figure>

<p>重新来一遍，又来一个报错：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+] [<span class="symbol">Thread</span> <span class="number">2000</span>]	b<span class="string">&#x27;libc&#x27;</span></span><br><span class="line">libc[+] [<span class="symbol">Thread</span> <span class="number">2000</span>]	b<span class="string">&#x27;: &#x27;</span></span><br><span class="line">: [+] [<span class="symbol">Thread</span> <span class="number">2000</span>]	b<span class="string">&#x27;Could not find a PHDR: broken executable?&#x27;</span></span><br><span class="line"><span class="symbol">Could</span> not find a <span class="symbol">PHDR</span>: broken executable?[+] [<span class="symbol">Thread</span> <span class="number">2000</span>]	b<span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里找不到 PHDR 程序头表，用readelf看一下：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -l libxx.so</span><br><span class="line"></span><br><span class="line">Elf file type is DYN (Shared object file)</span><br><span class="line">Entry point <span class="number">0</span>xa5370</span><br><span class="line">There are <span class="number">8</span> program headers, starting at offset <span class="number">64</span></span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           <span class="number">0</span>x00000<span class="number">00000000000</span> <span class="number">0</span>x00000<span class="number">00000000000</span> <span class="number">0</span>x00000<span class="number">00000000000</span></span><br><span class="line">                 <span class="number">0</span>x000000<span class="number">00002f25b4</span> <span class="number">0</span>x000000<span class="number">00002f25b4</span>  R E    <span class="number">0x10000</span></span><br><span class="line">  LOAD           <span class="number">0</span>x00000000002f2dc0 <span class="number">0</span>x0000000000302dc0 <span class="number">0</span>x0000000000302dc0</span><br><span class="line">                 <span class="number">0</span>x00000<span class="number">00000034478</span> <span class="number">0</span>x00000<span class="number">00000037d58</span>  RW     <span class="number">0x10000</span></span><br><span class="line">  DYNAMIC        <span class="number">0</span>x00000<span class="number">00000311f88</span> <span class="number">0</span>x00000<span class="number">00000321f88</span> <span class="number">0</span>x00000<span class="number">00000321f88</span></span><br><span class="line">                 <span class="number">0</span>x0000<span class="number">000000000210</span> <span class="number">0</span>x0000<span class="number">000000000210</span>  RW     <span class="number">0</span>x8</span><br><span class="line">  NOTE           <span class="number">0</span>x0000<span class="number">000000000200</span> <span class="number">0</span>x0000<span class="number">000000000200</span> <span class="number">0</span>x0000<span class="number">000000000200</span></span><br><span class="line">                 <span class="number">0</span>x00000<span class="number">00000000024</span> <span class="number">0</span>x00000<span class="number">00000000024</span>  R      <span class="number">0</span>x4</span><br><span class="line">  NOTE           <span class="number">0</span>x00000000002f251c <span class="number">0</span>x00000000002f251c <span class="number">0</span>x00000000002f251c</span><br><span class="line">                 <span class="number">0</span>x00000<span class="number">00000000098</span> <span class="number">0</span>x00000<span class="number">00000000098</span>  R      <span class="number">0</span>x4</span><br><span class="line">  GNU_EH_FRAME   <span class="number">0</span>x00000000002da5dc <span class="number">0</span>x00000000002da5dc <span class="number">0</span>x00000000002da5dc</span><br><span class="line">                 <span class="number">0</span>x000000000000355c <span class="number">0</span>x000000000000355c  R      <span class="number">0</span>x4</span><br><span class="line">  GNU_STACK      <span class="number">0</span>x00000<span class="number">00000000000</span> <span class="number">0</span>x00000<span class="number">00000000000</span> <span class="number">0</span>x00000<span class="number">00000000000</span></span><br><span class="line">                 <span class="number">0</span>x00000<span class="number">00000000000</span> <span class="number">0</span>x00000<span class="number">00000000000</span>  RW     <span class="number">0</span>x10</span><br><span class="line">  GNU_RELRO      <span class="number">0</span>x00000000002f2dc0 <span class="number">0</span>x0000000000302dc0 <span class="number">0</span>x0000000000302dc0</span><br><span class="line">                 <span class="number">0</span>x0000<span class="number">000000025240</span> <span class="number">0</span>x0000<span class="number">000000025240</span>  R      <span class="number">0</span>x1</span><br></pre></td></tr></table></figure>

<p>一般PHDR是程序表(program table)的第一个元素，这里确实没有。看一下IDA：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240717213805454.png" alt="image-20240717213805454"></p>
<p>这里也出现了一个变量+0x10的判断，对比Bet4的linker64上下文和PIXEL的linker64上下文，可确定是同一个问题，看来必须要往上逆向一下了。</p>
<blockquote>
<p>图的注释是分析后的结果。</p>
</blockquote>
<p>这里有两种方式，一种是打trace，即使用Qiling的hook_code，在每一条代码运行前打印现场环境，一种是断在对应的代码，单步做动态调试，这里我选择动态调试的方式。那如何断在对应的代码地址呢，这里要熟悉下qilingida.py的这部分代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_continue</span>(<span class="params">self</span>):</span><br><span class="line">    logging.info(<span class="string">&quot;before continue...&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.qlinit:</span><br><span class="line">        userhook = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 调用hook_code，每条指令执行前调用ql_path_hook</span></span><br><span class="line">        pathhook = <span class="variable language_">self</span>.qlemu.ql.hook_code(<span class="variable language_">self</span>.ql_path_hook)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ql_path_hook</span>(<span class="params">self, ql, addr, size</span>):</span><br><span class="line">    addr = addr - <span class="variable language_">self</span>.qlemu.baseaddr + get_imagebase()</span><br><span class="line">    set_color(addr, CIC_ITEM, <span class="number">0x007FFFAA</span>)</span><br><span class="line">    <span class="comment"># 获取断点数量</span></span><br><span class="line">    bp_count = get_bpt_qty()</span><br><span class="line">    bp_list = []</span><br><span class="line">    <span class="keyword">if</span> bp_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, bp_count):</span><br><span class="line">            bp_list.append(get_bpt_ea(num))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果当前准备执行的指令是断点处的指令，调用ql.save和ql.os.stop()保存当前模拟执行环境</span></span><br><span class="line">        <span class="keyword">if</span> addr <span class="keyword">in</span> bp_list <span class="keyword">and</span> (addr != <span class="variable language_">self</span>.lastaddr <span class="keyword">or</span> <span class="variable language_">self</span>.is_change_addr&gt;<span class="number">1</span>):</span><br><span class="line">            <span class="variable language_">self</span>.qlemu.status = ql.save()</span><br><span class="line">            ql.os.stop()</span><br><span class="line">            <span class="variable language_">self</span>.lastaddr = addr</span><br><span class="line">            <span class="variable language_">self</span>.is_change_addr = -<span class="number">1</span></span><br><span class="line">            jumpto(addr)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.is_change_addr += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>这部分代码表示让模拟执行跑起来时，如果遇到断点，就保存现场环境并停下来，所以断在想分析的代码地址处可以在ql_path_hook手动加一个断点，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_path_hook</span>(<span class="params">self, ql, addr, size</span>):</span><br><span class="line">    addr = addr - <span class="variable language_">self</span>.qlemu.baseaddr + get_imagebase()</span><br><span class="line">    set_color(addr, CIC_ITEM, <span class="number">0x007FFFAA</span>)</span><br><span class="line">    bp_count = get_bpt_qty() + <span class="number">1</span></span><br><span class="line">    bp_list = []</span><br><span class="line">    bp_list.append(<span class="number">0x27f2c</span>+<span class="number">0x007ffff7dd5000</span>-<span class="number">0x555555554000</span>)</span><br><span class="line">    <span class="keyword">if</span> bp_count &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, bp_count):</span><br><span class="line">            bp_list.append(get_bpt_ea(num))</span><br></pre></td></tr></table></figure>

<p>这里给bp_list加一个元素，0x27f2c为相对虚拟地址(RVA)，后面是重定位的基址调整，这样就能断下来，然后单步调试了。</p>
<blockquote>
<ul>
<li><p>因为第二行addr变量重定位时减去的libxx模块的基址，所以bp_list添加的元素要减去libxx模块的基址，而不是0x27f2c+0x007ffff7dd5000-0x007ffff7dd5000&#x3D;0x27f2c。</p>
</li>
<li><p>因为中断后，PC寄存器指向linker64模块，所以会报以下错误，不过该错误不影响继续单步调试：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[x] [Thread <span class="number">2000</span>]	[Thread <span class="number">2000</span>] Expect <span class="number">0</span>x5555555f9370 but get <span class="number">0</span>x7ffff7e9e920 when running loader.</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\l</span>inux.py&quot;</span>, line <span class="number">167</span>, <span class="keyword">in</span> run</span><br><span class="line">    thread_management.run()</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">613</span>, <span class="keyword">in</span> run</span><br><span class="line">    <span class="attr">previous_thread</span> <span class="operator">=</span> self._prepare_lib_patch()</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">593</span>, <span class="keyword">in</span> _prepare_lib_patch</span><br><span class="line">    raise QlErrorExecutionStop(&#x27;Dynamic library .init() failed<span class="operator">!</span>&#x27;)</span><br><span class="line">qiling.exception.<span class="params">QlErrorExecutionStop:</span> Dynamic library .init() failed<span class="operator">!</span></span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<p>单步调试后，伪代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (program_table_element[i].p_type!=PT_PHDR) &#123;</span><br><span class="line">	i++;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= elf_header.e_phnum)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (i == elf_header.e_phnum) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no phdr&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 获取文件基址在内存的地址</span></span><br><span class="line">    a = phdr_addr - program_table_element[i].p_paddr;</span><br><span class="line">    <span class="comment">// 获取内存基址</span></span><br><span class="line">    b = phdr_addr - program_table_elemet[i].p_offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以模拟程序头表获取变量a和变量b，修改custom_script.py如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">custom_continue</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="type">List</span>[HookRet]:</span><br><span class="line">	<span class="comment">#...</span></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">addr_27FB4_hook</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        	<span class="comment"># 如果是检测第一个程序表元素，且不是程序头表</span></span><br><span class="line">            <span class="keyword">if</span> ql.arch.regs.X11 == <span class="number">0</span> <span class="keyword">and</span> ql.arch.regs.W12 == <span class="number">1</span>:</span><br><span class="line">                phdr_vir_addr = ql.arch.regs.X8</span><br><span class="line">                poffset_addr = ql.arch.regs.x10</span><br><span class="line">                write_base = ql.arch.regs.X19</span><br><span class="line">                ql.log.info(<span class="string">f&#x27;phdr_vir_addr: <span class="subst">&#123;phdr_vir_addr:#x&#125;</span>&#x27;</span>)</span><br><span class="line">                ql.log.info(<span class="string">f&#x27;poffset_addr: <span class="subst">&#123;poffset_addr:#x&#125;</span>&#x27;</span>)</span><br><span class="line">                sub1 = to_bstring(phdr_vir_addr-<span class="number">0x40</span>)</span><br><span class="line">                <span class="comment"># *(QWORD*)((__int64)v50+0x100) = image_vir_addr</span></span><br><span class="line">                ql.mem.write(write_base+<span class="number">0x100</span>, sub1)</span><br><span class="line">                ql.log.info(<span class="string">b&#x27;sub1: &#x27;</span> + sub1)</span><br><span class="line"></span><br><span class="line">                image_vir_addr = phdr_vir_addr-<span class="number">0x40</span></span><br><span class="line">                <span class="comment"># *(QWORD*)((__int64)v50+0x10) = image_vir_addr</span></span><br><span class="line">                ql.mem.write(write_base+<span class="number">0x10</span>, to_bstring(<span class="number">0x40</span>))</span><br><span class="line">                ql.log.info(<span class="string">f&#x27;sub2: <span class="subst">&#123;image_vir_addr:#x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                ql.arch.regs.X8 = image_vir_addr</span><br><span class="line">                ql.arch.regs.PC = <span class="number">0x28070</span> + <span class="number">0x7ffff7dd5000</span></span><br><span class="line">                </span><br><span class="line">	ql.hook_address(addr_27FB4_hook, <span class="number">0x27FB4</span>+linker_baseaddr)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>记得把之前在qilingida.py添加的断点去掉。</p>
</blockquote>
<p>重启qiling环境，这样就能够断在libxx.so的start地址处了。</p>
<p>遗憾的是，到这里仍然不能顺利模拟执行我们的目标函数，因为qiling模拟执行到start大约需要3-4分钟，如果每次分析调整完qiling代码后，都重启一次qiling，那这个效率就太低了。</p>
<p>写这篇文章的时候，为了演示，我重新又走了一遍流程，结果这次直接卡死了，IDA一直消耗CPU一整晚，到白天都还没有弄完：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240724102141265.png" alt="image-20240724102141265"></p>
<p>经过分析，发现通过Qiling-&gt;Continue的方式，每执行一条执行都会调用设置的callback（qilingida.py-&gt;ql_path_hook），如果取消这个回调注册，qiling就会大约2-3秒来到start地址处。</p>
<p>重启qiling环境，这次遇到了这个错误：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	v28	: <span class="number">0x0</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	v29	: <span class="number">0x0</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	v30	: <span class="number">0x0</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	v31	: <span class="number">0x0</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">PC</span> = <span class="number">0x0000000000000000</span> (unreachable)</span><br><span class="line"></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">Memory</span> map:</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="symbol">Start</span>            <span class="symbol">End</span>              <span class="symbol">Perm</span>    <span class="symbol">Label</span>              <span class="symbol">Image</span></span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">00555555554000</span> - <span class="number">00555555847000</span>   r-x     libxx.so           <span class="symbol">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\bin\libxx.so</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">00555555856000</span> - <span class="number">0055555587</span>c000   r--     libxx.so           <span class="symbol">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\bin\libxx.so</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">0055555587</span>c000 - <span class="number">0055555588</span>f000   rw-     libxx.so           <span class="symbol">E</span>:\gitRepo\qiling\examples\rootfs\arm64_linux\bin\libxx.so</span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">0055555588</span>f000 - <span class="number">00555555891000</span>   rwx     [hook_mem]         </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dd6000 - <span class="number">007</span>fffb7dd7000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dd7000 - <span class="number">007</span>fffb7dda000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dda000 - <span class="number">007</span>fffb7ddb000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7ddb000 - <span class="number">007</span>fffb7ddc000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7ddc000 - <span class="number">007</span>fffb7de0000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de0000 - <span class="number">007</span>fffb7de1000   r--     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de1000 - <span class="number">007</span>fffb7de2000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de2000 - <span class="number">007</span>fffb7de3000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de3000 - <span class="number">007</span>fffb7de4000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de5000 - <span class="number">007</span>fffb7de6000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de6000 - <span class="number">007</span>fffb7de7000   r--     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de7000 - <span class="number">007</span>fffb7de8000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de8000 - <span class="number">007</span>fffb7de9000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7de9000 - <span class="number">007</span>fffb7dea000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dea000 - <span class="number">007</span>fffb7deb000   r--     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7deb000 - <span class="number">007</span>fffb7dec000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dec000 - <span class="number">007</span>fffb7ded000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7ded000 - <span class="number">007</span>fffb7dee000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7dee000 - <span class="number">007</span>fffb7def000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7def000 - <span class="number">007</span>fffb7df0000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7df0000 - <span class="number">007</span>fffb7df1000   r--     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7df1000 - <span class="number">007</span>fffb7df2000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7e31000 - <span class="number">007</span>fffb7e32000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7e32000 - <span class="number">007</span>fffb7e33000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7e4b000 - <span class="number">007</span>fffb7f0e000   r-x     [mmap] libc.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f0e000 - <span class="number">007</span>fffb7f1d000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f1d000 - <span class="number">007</span>fffb7f23000   r--     [mmap] libc.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f23000 - <span class="number">007</span>fffb7f26000   rw-     [mmap] libc.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f26000 - <span class="number">007</span>fffb7f34000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f5d000 - <span class="number">007</span>fffb7f5e000   r-x     [mmap] libdl.so    </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f5e000 - <span class="number">007</span>fffb7f6d000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f6d000 - <span class="number">007</span>fffb7f6e000   r--     [mmap] libdl.so    </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f6e000 - <span class="number">007</span>fffb7f6f000   rw-     [mmap] libdl.so    </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb7f81000 - <span class="number">007</span>fffb8058000   r-x     [mmap] libc++.so   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8058000 - <span class="number">007</span>fffb8067000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8067000 - <span class="number">007</span>fffb806e000   r--     [mmap] libc++.so   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb806e000 - <span class="number">007</span>fffb806f000   rw-     [mmap] libc++.so   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb806f000 - <span class="number">007</span>fffb8072000   rw-     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb80b5000 - <span class="number">007</span>fffb80ed000   r-x     [mmap] libm.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb80ed000 - <span class="number">007</span>fffb80fd000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb80fd000 - <span class="number">007</span>fffb80fe000   r--     [mmap] libm.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb80fe000 - <span class="number">007</span>fffb80ff000   rw-     [mmap] libm.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8106000 - <span class="number">007</span>fffb8122000   r-x     [mmap] libz.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8122000 - <span class="number">007</span>fffb8131000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8131000 - <span class="number">007</span>fffb8132000   r--     [mmap] libz.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8132000 - <span class="number">007</span>fffb8133000   rw-     [mmap] libz.so     </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8160000 - <span class="number">007</span>fffb8165000   r-x     [mmap] liblog.so   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8165000 - <span class="number">007</span>fffb8174000   ---     [mmap anonymous]   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8174000 - <span class="number">007</span>fffb8175000   r--     [mmap] liblog.so   </span><br><span class="line">[x] [<span class="symbol">Thread</span> <span class="number">2000</span>]	<span class="number">007</span>fffb8175000 - <span class="number">007</span>fffb8176000   rw-     [mmap] liblog.so   </span><br><span class="line">...</span><br><span class="line">  <span class="symbol">File</span> <span class="string">&quot;C:\Program Files\Python39\lib\site-packages\qiling\core.py&quot;</span>, line <span class="number">771</span>, in emu_start</span><br><span class="line">    self.uc.emu_start(begin, end, timeout, count)</span><br><span class="line">  <span class="symbol">File</span> <span class="string">&quot;C:\Program Files\Python39\lib\site-packages\unicorn\unicorn.py&quot;</span>, line <span class="number">547</span>, in emu_start</span><br><span class="line">    raise <span class="symbol">UcError</span>(status)</span><br><span class="line">unicorn.unicorn.<span class="symbol">UcError</span>: <span class="symbol">Invalid</span> memory fetch (<span class="symbol">UC_ERR_FETCH_UNMAPPED</span>)</span><br></pre></td></tr></table></figure>

<p>这里PC跳到了0x0，不过我们可以看到libxx.so需要的依赖库都被完美地加载到内存了，说明动态链接器加载libxx.so应该是完成了。</p>
<p>因为取消了ql_path_hook的回调，所以不能断到断点处，所以得另外用一种方法断到start地址处。</p>
<p>qiling有一个“运行到”的函数，右键是Qiling-&gt;Execute Till，观察qiling的IDA插件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_run_to_here</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.qlinit:</span><br><span class="line">        curr_addr = get_screen_ea()</span><br><span class="line">        <span class="comment"># 每执行一条命令前，调用ql_until_hook</span></span><br><span class="line">        untillhook = <span class="variable language_">self</span>.qlemu.ql.hook_code(<span class="variable language_">self</span>.ql_untill_hook)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.qlemu.status <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.qlemu.ql.restore(<span class="variable language_">self</span>.qlemu.status)</span><br><span class="line">            show_wait_box(<span class="string">&quot;Qiling is processing ...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.qlemu.run(begin=<span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc, end=curr_addr+<span class="variable language_">self</span>.qlemu.baseaddr-get_imagebase())</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                hide_wait_box()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            show_wait_box(<span class="string">&quot;Qiling is processing ...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.qlemu.run(end=curr_addr+<span class="variable language_">self</span>.qlemu.baseaddr-get_imagebase())</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                hide_wait_box()</span><br></pre></td></tr></table></figure>

<p>qiling在run方法中提供了end，代表模拟执行在哪里结束。我们可以把end设置为start地址就相当于断在start上了，通过在IDA将光标移到对应的代码处即可设置end。不过这里也有一个指令级回调（第5行），观察ql_until_hook的实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_untill_hook</span>(<span class="params">self, ql, addr, size</span>):</span><br><span class="line">    addr = addr - <span class="variable language_">self</span>.qlemu.baseaddr + get_imagebase()</span><br><span class="line">    set_color(addr, CIC_ITEM, <span class="number">0x00B3CBFF</span>)</span><br></pre></td></tr></table></figure>

<p>该函数只是将模拟执行过的代码设置高亮，因此我们可以直接注视掉这个回调的注册（在ql_run_to_here去掉对ql_until_hook的hook_code和hook_del调用）。另外，之前在custom_continue设置的回调都要copy一份到custom_run_to_here，由于custom_script.py没有custom_run_to_here函数，那么就创建一个：</p>
<p>qilingida.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ql_run_to_here</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.qlinit:</span><br><span class="line">        curr_addr = get_screen_ea()</span><br><span class="line">        userhook = <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 注册新创建的custom_run_to_here方法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.userobj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            userhook = <span class="variable language_">self</span>.userobj.custom_run_to_here(<span class="variable language_">self</span>.qlemu.ql)</span><br><span class="line">        <span class="comment"># 去掉ql_until_hook的回调</span></span><br><span class="line">        <span class="comment"># untillhook = self.qlemu.ql.hook_code(self.ql_untill_hook)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.qlemu.status <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.qlemu.ql.restore(<span class="variable language_">self</span>.qlemu.status)</span><br><span class="line">            show_wait_box(<span class="string">&quot;Qiling is processing ...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.qlemu.run(begin=<span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc, end=curr_addr+<span class="variable language_">self</span>.qlemu.baseaddr-get_imagebase())</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                hide_wait_box()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            show_wait_box(<span class="string">&quot;Qiling is processing ...&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="variable language_">self</span>.qlemu.run(end=curr_addr+<span class="variable language_">self</span>.qlemu.baseaddr-get_imagebase())</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                hide_wait_box()</span><br><span class="line"></span><br><span class="line">        set_color(curr_addr, CIC_ITEM, <span class="number">0x00B3CBFF</span>)</span><br><span class="line">        <span class="comment"># 回调删除部分也注视掉</span></span><br><span class="line">        <span class="comment"># self.qlemu.ql.hook_del(untillhook)</span></span><br><span class="line">        <span class="keyword">if</span> userhook <span class="keyword">and</span> userhook <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">for</span> hook <span class="keyword">in</span> userhook:</span><br><span class="line">                <span class="variable language_">self</span>.qlemu.ql.hook_del(hook)</span><br><span class="line">        <span class="variable language_">self</span>.qlemu.status = <span class="variable language_">self</span>.qlemu.ql.save()</span><br><span class="line">        <span class="variable language_">self</span>.ql_update_views(<span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc, <span class="variable language_">self</span>.qlemu.ql)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.error(<span class="string">&#x27;Qiling should be setup firstly.&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>custom_script.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">custom_run_to_here</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="type">List</span>[HookRet]:</span><br><span class="line"></span><br><span class="line">    linker_baseaddr = <span class="number">0x007ffff7dd5000</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addr_27DA8_hook</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">		<span class="comment"># content from custom_continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addr_27FB4_hook</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># content from custom_continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ql.hook_address(addr_27DA8_hook, <span class="number">0x27DA8</span>+linker_baseaddr),</span><br><span class="line">            ql.hook_address(addr_27FB4_hook, <span class="number">0x27FB4</span>+linker_baseaddr)]</span><br></pre></td></tr></table></figure>

<p>OK，输出终于没有报错了，观察寄存器，也顺利执行到了start地址处：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240724163047823.png" alt="image-20240724163047823"></p>
<p>修改之后，重启qiling环境，将光标移到start代码处，右键Qiling-&gt;Execute Till。</p>
<p>接下来就是单步执行了，结果遇到如下问题：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="operator">=</span>] [Thread <span class="number">2000</span>]	custom_step hook</span><br><span class="line">[<span class="operator">=</span>] [Thread <span class="number">2001</span>]	<span class="params">Executing:</span> <span class="number">0</span>x7ffff7e0373c</span><br><span class="line">[x] [Thread <span class="number">2001</span>]	[Thread <span class="number">2001</span>] Expect <span class="number">0</span>x5555555f9370 but get <span class="number">0</span>x7ffff7e03740 when running loader.</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">611</span>, <span class="keyword">in</span> run</span><br><span class="line">    <span class="attr">previous_thread</span> <span class="operator">=</span> self._prepare_lib_patch()</span><br><span class="line">  File <span class="string">&quot;C:<span class="char escape_">\P</span>rogram Files<span class="char escape_">\P</span>ython39<span class="char escape_">\l</span>ib<span class="char escape_">\s</span>ite-packages<span class="char escape_">\q</span>iling<span class="char escape_">\o</span>s<span class="char escape_">\l</span>inux<span class="char escape_">\t</span>hread.py&quot;</span>, line <span class="number">590</span>, <span class="keyword">in</span> _prepare_lib_patch</span><br><span class="line">    raise QlErrorExecutionStop(&#x27;Dynamic library .init() failed<span class="operator">!</span>&#x27;)</span><br><span class="line">qiling.exception.<span class="params">QlErrorExecutionStop:</span> Dynamic library .init() failed<span class="operator">!</span></span><br></pre></td></tr></table></figure>

<p>这里显示单步执行的命令地址是0x7ffff7e0373c，而不是0x5555555f9370。要定位这个问题需要了解qiling源码，分析流程如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qilingida.py</span></span><br><span class="line"><span class="comment"># 单步执行的入口是qlemu.run</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ql_step</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="variable language_">self</span>.qlemu.run(begin=<span class="variable language_">self</span>.qlemu.ql.arch.regs.arch_pc, end=<span class="variable language_">self</span>.qlemu.exit_addr)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># qiling/os/linux/linux.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QlOsLinux</span>(<span class="title class_ inherited__">QlOsPosix</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.ql.multithread:</span><br><span class="line">            <span class="comment"># start multithreading</span></span><br><span class="line">            <span class="comment"># 多线程环境下调用thread_management.run()</span></span><br><span class="line">            thread_management = thread.QlLinuxThreadManagement(<span class="variable language_">self</span>.ql)</span><br><span class="line">            <span class="variable language_">self</span>.ql.os.thread_management = thread_management</span><br><span class="line">            thread_management.run()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 单线程环境</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.ql.entry_point <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.ql.loader.elf_entry = <span class="variable language_">self</span>.ql.entry_point</span><br><span class="line"></span><br><span class="line">            <span class="comment"># do we have an interp?</span></span><br><span class="line">            <span class="comment"># 如果有动态链接器，就用动态链接器初始化目标so</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="variable language_">self</span>.ql.loader.elf_entry != <span class="variable language_">self</span>.ql.loader.entry_point:</span><br><span class="line">                entry_address = <span class="variable language_">self</span>.ql.loader.elf_entry</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.ql.arch.<span class="built_in">type</span> == QL_ARCH.ARM:</span><br><span class="line">                    entry_address &amp;= ~<span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># start running interp, but stop when elf entry point is reached</span></span><br><span class="line">                <span class="variable language_">self</span>.ql.emu_start(<span class="variable language_">self</span>.ql.loader.entry_point, entry_address, <span class="variable language_">self</span>.ql.timeout)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 开始模拟执行目标so</span></span><br><span class="line">            <span class="variable language_">self</span>.ql.emu_start(<span class="variable language_">self</span>.ql.loader.elf_entry, <span class="variable language_">self</span>.exit_point, <span class="variable language_">self</span>.ql.timeout, <span class="variable language_">self</span>.ql.count)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># qiling/os/linux/thread.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">QlLinuxThreadManagement</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 调用_prepare_lib_patch，让动态链接器加载目标libxx.so</span></span><br><span class="line">        previous_thread = <span class="variable language_">self</span>._prepare_lib_patch()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_prepare_lib_patch</span>(<span class="params">self</span>):</span><br><span class="line">		<span class="comment"># 如果有动态链接器，就用动态链接器初始化目标libxx.so</span></span><br><span class="line">		<span class="keyword">if</span> <span class="variable language_">self</span>.ql.loader.elf_entry != <span class="variable language_">self</span>.ql.loader.entry_point:</span><br><span class="line">            entry_address = <span class="variable language_">self</span>.ql.loader.elf_entry</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.ql.arch.<span class="built_in">type</span> == QL_ARCH.ARM:</span><br><span class="line">                entry_address &amp;= ~<span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.main_thread = <span class="variable language_">self</span>.ql.os.thread_class.spawn(<span class="variable language_">self</span>.ql, <span class="variable language_">self</span>.ql.loader.entry_point, entry_address)</span><br><span class="line">            <span class="variable language_">self</span>.cur_thread = <span class="variable language_">self</span>.main_thread</span><br><span class="line">            <span class="variable language_">self</span>._clear_queued_msg()</span><br><span class="line">            gevent.joinall([<span class="variable language_">self</span>.main_thread], raise_error=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.ql.arch.regs.arch_pc != entry_address:</span><br><span class="line">                <span class="variable language_">self</span>.ql.log.error(<span class="string">f&quot;<span class="subst">&#123;self.cur_thread&#125;</span> Expect <span class="subst">&#123;<span class="built_in">hex</span>(self.ql.loader.elf_entry)&#125;</span> but get <span class="subst">&#123;<span class="built_in">hex</span>(self.ql.arch.regs.arch_pc)&#125;</span> when running loader.&quot;</span>)</span><br><span class="line">                <span class="keyword">raise</span> QlErrorExecutionStop(<span class="string">&#x27;Dynamic library .init() failed!&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.ql.do_lib_patch()</span><br><span class="line">            <span class="variable language_">self</span>.ql.os.run_function_after_load()</span><br><span class="line">            <span class="variable language_">self</span>.ql.loader.skip_exit_check = <span class="literal">False</span></span><br><span class="line">            <span class="variable language_">self</span>.ql.write_exit_trap()</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.main_thread</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>观察代码流程，我们发现单线程环境下，如果指定了ql.entry_point（调用ql.run的begin参数），就不会用动态加载器去重定位，而是直接开始模拟执行。这是正常的，因为第一次模拟执行时我们一般不会指定ql.run的begin参数，而是让动态链接器去初始化so，不过我们会注册一些回调，使得之后可以保存快照和恢复模拟执行，而恢复模拟执行就会设置ql.run的begin参数。再看多线程的环境，qiling官方显然没有考虑到这个，每次调用ql.run都会执行_prepare_lib_path，都用动态链接器初始化so。在我们的场景下，我们已经初始化过libxx.so，想要开始单步调试so，而由于qiling又一次初始化libxx.so，所以单步调试后的下一条指令是动态加载器的入口地址+4，而不是libxx.so的入口地址+4。</p>
<p>这里直接模仿单线程环境，修改如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qiling/os/linux/thread.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_prepare_lib_patch</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.ql.entry_point <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.ql.loader.elf_entry = <span class="variable language_">self</span>.ql.entry_point</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="variable language_">self</span>.ql.loader.elf_entry != <span class="variable language_">self</span>.ql.loader.entry_point:</span><br><span class="line">        entry_address = <span class="variable language_">self</span>.ql.loader.elf_entry</span><br></pre></td></tr></table></figure>

<p>这里添加一个ql.entry_point的判断，如果ql.run设置了begin，就不重定位，直接从begin地址处开始模拟执行。</p>
<p>重启qiling环境，再次执行Qiling-&gt;Execute Till：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725103246929.png" alt="image-20240725103246929"></p>
<p>可以看到，这次单步调试成功了，顺利断在了libxx.so的下一条指令。</p>
<p>继续单步执行，进入”.__cxa_finalize”函数，该函数是从内存读取__cxa_finalize真正的函数地址并执行，该函数地址是需要重定位的，因为该函数属于其他模块，我们观察其内存：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725103947132.png" alt="image-20240725103947132"></p>
<p>__cxa_finalize_ptr是保存函数地址的指针，通过IDA View-B可看到其相对虚拟地址是0x3266D0，X16寄存器保存了__cxa_finalize_ptr所在的内存页，我们查看内存，发现0x6D0偏移处是0x7FFFB80F942C，该地址位于libc.so中，所以由此得知动态链接器正确地完成了libxx.so的重定位。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[x]</span> <span class="selector-attr">[Thread 2000]</span>	<span class="number">007</span>fffb8085000 - <span class="number">007</span>fffb8148000   <span class="attribute">r</span>-<span class="attribute">x</span>     <span class="selector-attr">[mmap]</span> libc<span class="selector-class">.so</span></span><br></pre></td></tr></table></figure>

<h2 id="虚拟机框架解析"><a href="#虚拟机框架解析" class="headerlink" title="虚拟机框架解析"></a>虚拟机框架解析</h2><p>libxx.so有3个重要的接口：</p>
<ul>
<li>tps_init：tps_init初始化和收集环境信息，发送给服务器</li>
<li>tps_encrypt、tps_decrypt：负责数据的加解密</li>
</ul>
<p>因为tps_init与算法无关，这里就直接忽略了。</p>
<p>先看下加解密函数的伪代码：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725105318159.png" alt="image-20240725105318159"></p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725105333731.png" alt="image-20240725105333731"></p>
<p>两个函数结构一致，sub_F736C是真正的加解密函数，加密与解密的不同在于sub_F736C的第1、3、4参数。</p>
<h3 id="虚拟机的简要流程"><a href="#虚拟机的简要流程" class="headerlink" title="虚拟机的简要流程"></a>虚拟机的简要流程</h3><p>回顾sub_F736C的整体结构：</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725105747850.png" alt="image-20240725105747850"></p>
<p>感觉像是几层嵌套的控制流平坦化，通过单步模拟执行，其实际上是一个虚拟机的简化版，这里简要说明其流程：</p>
<ul>
<li><p>初始化一些计算因子，然后进入while(1)无限循环，v66从a1参数读取一个四字节大小的无符号整形，然后与0x3F做&amp;算法，最后传给switch</p>
<blockquote>
<p>这里IDA反编译出现了一点问题，传给switch的不是v39</p>
</blockquote>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725134708083.png" alt="image-20240725134708083"></p>
</li>
<li><p>一个大switch</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725110152019.png" alt="image-20240725110152019"></p>
</li>
<li><p>假如v39是0x9，跳到对应的case，执行[vmstack-off1] &#x3D; [vmstack-off2] + number，之后跳到LABEL_331</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725110448988.png" alt="image-20240725110448988"></p>
</li>
<li><p>LABEL_331是所有case的最后一段代码，类似switch的所有case都没有break，然后都跳转到了default分支下</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725135938807.png" alt="image-20240725135938807"></p>
<p>LABEL_331有两个功能：</p>
<ul>
<li><p>改变控制流，做指令跳转</p>
<ul>
<li><p>一种是a1数组自增到下一个元素</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a1 = (<span class="type">unsigned</span> <span class="type">int</span> *)(*(_QWORD *)beg + <span class="number">4LL</span>);</span><br><span class="line">*(_QWORD *)beg = a1;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一种是直接跳转到a1数组的某个元素</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//func_data - 0x18地址处保存的是上一个switch-case写入的值</span></span><br><span class="line">a1 = *(<span class="type">unsigned</span> <span class="type">int</span> **)(func_data - <span class="number">0x18</span>);</span><br><span class="line">*(_QWORD *)(func_data - <span class="number">0x20</span>) = <span class="number">0LL</span>;</span><br><span class="line">*(_QWORD *)beg = a1;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>调用回调函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">real_data = ((__int64 (__fastcall *)(_QWORD, _QWORD))func)(*v13, *v14);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>最后，回到while(1)，继续走switch。</p>
</li>
</ul>
<h3 id="虚拟机结构剖析"><a href="#虚拟机结构剖析" class="headerlink" title="虚拟机结构剖析"></a>虚拟机结构剖析</h3><ul>
<li><p>switch-case的参数来源：sub_F736C的第一个参数是一个4字节数组，每个4字节的一部分都是switch-case的参数，用来执行一个操作。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725113411862.png" alt="image-20240725113411862"></p>
<p>因此每一个4字节就是一个handler，其handler的内部解析如下，handler index和subhandler index为switch-case的参数。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725135546287.png" alt="image-20240725135546287"></p>
</li>
<li><p>handler的执行示例：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">handler index:0x2B</span><br><span class="line">subhandler index:0xC2B</span><br><span class="line">handler：<span class="comment">[vm_stack-off3]</span> = <span class="comment">[vm_stack-off1]</span> + <span class="comment">[vm_stack-off2]</span></span><br><span class="line">example:</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x110]</span> = <span class="comment">[func_data-0x80]</span> + <span class="comment">[func_data-0x128]</span>; 0xffffffffff971488, 0x555555cd9eb0, rs: 0x55555564b338</span><br><span class="line">------------------------------------------------</span><br><span class="line">handler index:0x2B</span><br><span class="line">subhandler index:0xA6B</span><br><span class="line">handler:<span class="comment">[vm_stack-off3]</span> = <span class="comment">[vm_stack-off1]</span> &gt;&gt; operand2</span><br><span class="line">example:</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x88]</span> &gt;&gt; 0x18; 0x555f9370, rs: 0x55</span><br><span class="line">------------------------------------------------</span><br><span class="line">handler index:0x9</span><br><span class="line">no subhandler index</span><br><span class="line">handler:<span class="comment">[vm_stack-off1]</span> = <span class="comment">[vm_stack-off2]</span> + operand1</span><br><span class="line">example:</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x130]</span> + 0x4; 0x0, rs: 0x4</span><br></pre></td></tr></table></figure>

<p>看第一个例子，index为0x2B，则进一步判断subindex，执行subindex为0xC2B的操作，这里有3个变量，off1、off2、off3，分别从handler中做位运算提取。</p>
</li>
<li><p>控制流的变化</p>
<p>加解密的执行就是遍历handler数组实现的，一个handler一个handler的执行。对于for循环，虚拟机需要改变控制流来实现，以下给出控制流改变的一个例子：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">        <span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">        <span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xfffc &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5bd0</span><br><span class="line">        <span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x120]</span> + 0x1; func_data-0x234, rs: func_data-0x233</span><br><span class="line">        index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5bc4</span><br><span class="line">        <span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">        <span class="comment">[beg]</span> = index_table_pointer</span><br></pre></td></tr></table></figure>

<p>执行0x34 handler，如果*(DWORD*)(func_data-0x130）!&#x3D; *(DWORD*)(func_data-0x128），handler数组指针就减0xC，并且func_data-0x20地址处写入2，表示下一个handler执行后即将跳转：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">index_table_pointer</span>+<span class="number">4</span>+((int)(<span class="number">0</span>xfffc &lt;&lt; <span class="number">0</span>x10) &gt;&gt; <span class="number">0</span>xE) = index_table_pointer-<span class="number">0</span>xC = <span class="number">0</span>x5555557e5bd0-<span class="number">0</span>xC= <span class="number">0</span>x5555557e5bc4</span><br></pre></td></tr></table></figure>

<p>执行下一条0x9 handler时，因为func_data-0x20地址处的值为2，所以让handler跳转到0x5555557e5bc4。</p>
<p>如果0x34 handler执行时*(DWORD*)(func_data-0x130）&#x3D;&#x3D; *(DWORD*)(func_data-0x128），那么下一个handler执行后仍顺序执行。</p>
</li>
</ul>
<h3 id="虚拟机执行流程解析"><a href="#虚拟机执行流程解析" class="headerlink" title="虚拟机执行流程解析"></a>虚拟机执行流程解析</h3><p>每次执行一个handler，相当于进入switch走一遍，因为我们已经解析了handler4字节的内部组成，所以我们可以记录每一条handler具体代表的语义。每当进入switch时，我们把当前handler的语义打出来，就可以看到完整的加解密流程了。</p>
<p><img data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/reverse/libxx_algorithm_analysis/image-20240725141947203.png" alt="image-20240725141947203"></p>
<p>于是，我们调用ql.hook_code方法，每当执行到0xF7E20这，就打印handler语义：</p>
<p>更新custom_script.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">custom_run_to_here</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="type">List</span>[HookRet]:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">addr_tps_F7E20_hook</span>(<span class="params">ql: Qiling</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># ql.log.info(f&#x27;index_base: &#123;ql.arch.regs.X19:#x&#125;&#x27;)</span></span><br><span class="line">        index = ql.arch.regs.X12 &amp; <span class="number">0x3F</span></span><br><span class="line">        <span class="comment"># ql.log.info(f&#x27;index_value: &#123;index:#x&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># ql.log.info(f&#x27;off1: &#123;ql.arch.regs.W8:#x&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># ql.log.info(f&#x27;off2: &#123;ql.arch.regs.W9:#x&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">        indent = <span class="string">f&#x27;\n\t\t\t\t\t\t&#x27;</span></span><br><span class="line">        off = calc_off(ql)</span><br><span class="line">        W11 = calc_W11(ql)</span><br><span class="line">        rs = <span class="string">f&#x27;index: <span class="subst">&#123;index:#x&#125;</span> -&gt; &#x27;</span></span><br><span class="line">        base_W8 = <span class="string">f&#x27;[func_data-<span class="subst">&#123;<span class="number">0x130</span>-ql.arch.regs.W8*<span class="number">8</span>:#x&#125;</span>]&#x27;</span></span><br><span class="line">        base_W9 = <span class="string">f&#x27;[func_data-<span class="subst">&#123;<span class="number">0x130</span>-ql.arch.regs.W9*<span class="number">8</span>:#x&#125;</span>]&#x27;</span></span><br><span class="line">        base_W10 = <span class="string">f&#x27;[func_data-<span class="subst">&#123;<span class="number">0x130</span>-ql.arch.regs.W10*<span class="number">8</span>:#x&#125;</span>]&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> update_index_table_flag</span><br><span class="line">        <span class="keyword">if</span> update_index_table_flag == <span class="number">2</span>:</span><br><span class="line">            update_index_table_flag += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0x9</span> <span class="keyword">or</span> index == <span class="number">0x1C</span>:</span><br><span class="line">            base_W9_value = get_base_W9(ql)</span><br><span class="line">            rs += <span class="string">f&#x27;<span class="subst">&#123;base_W8&#125;</span> = <span class="subst">&#123;base_W9&#125;</span> + <span class="subst">&#123;off:#x&#125;</span>; <span class="subst">&#123;get_base(ql, base_W9_value)&#125;</span>, rs: <span class="subst">&#123;get_base(ql, base_W9_value+off)&#125;</span>&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> index <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">0x34</span>]:</span><br><span class="line">            flag_20 = ql.arch.regs.X0</span><br><span class="line">            <span class="keyword">if</span> flag_20 != <span class="number">0</span>:</span><br><span class="line">                rs += <span class="string">&quot;ignore!!&quot;</span></span><br><span class="line">            v78 = <span class="string">f&#x27;(int)(<span class="subst">&#123;off:#x&#125;</span> &lt;&lt; 0x10) &gt;&gt; 0xE&#x27;</span></span><br><span class="line">            v77 = get_base_W8(ql)</span><br><span class="line">            rs += <span class="string">f&#x27;<span class="subst">&#123;base_W8&#125;</span>; <span class="subst">&#123;v77:#x&#125;</span>&#x27;</span></span><br><span class="line">            v79 = get_base_W9(ql)</span><br><span class="line">            rs += <span class="string">f&#x27;<span class="subst">&#123;indent&#125;</span><span class="subst">&#123;base_W9&#125;</span>; <span class="subst">&#123;v79:#x&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">            str1 = <span class="string">f&#x27;<span class="subst">&#123;indent&#125;</span>[func_data-0x18] = index_table_pointer+8(2 elements); <span class="subst">&#123;ql.arch.regs.X19:#x&#125;</span>, rs: <span class="subst">&#123;ql.arch.regs.X19+<span class="number">8</span>:#x&#125;</span>&#x27;</span></span><br><span class="line">            str2 = <span class="string">f&#x27;<span class="subst">&#123;indent&#125;</span>[func_data-0x18] = index_table_pointer+4+(<span class="subst">&#123;v78&#125;</span>); <span class="subst">&#123;ql.arch.regs.X19:#x&#125;</span>&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> v77 != v79:</span><br><span class="line">                    rs += str1</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rs += str2</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">0x34</span>:</span><br><span class="line">                <span class="keyword">if</span> v77 == v79:</span><br><span class="line">                    rs += str1</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rs += str2</span><br><span class="line">		<span class="comment"># elif...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> log_flag:</span><br><span class="line">            ql.log.info(rs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ql.hook_address(addr_27DA8_hook, <span class="number">0x7ffff7dfcda8</span>),</span><br><span class="line">            ql.hook_address(addr_27FB4_hook, <span class="number">0x7ffff7dfcfb4</span>),</span><br><span class="line">            ql.hook_address(addr_tps_ADAB8_hook, <span class="number">0x555555601ab8</span>),</span><br><span class="line">            ql.hook_address(addr_tps_F7E20_hook, <span class="number">0x55555564be20</span>)]</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>完整的custom_script.py已上传至附件。</p>
</li>
<li><p>因为switch-case有些路径是没有走到的，也就是说加解密的handler不是全集，所以我们在写handler的时候，只需要一个一个写，遇到一个新的待执行的handler，就增加一个elif，不需要把switch-case的所有路径都挨着写完。</p>
</li>
<li><p>当我们新增handler时，就需要重启qiling环境，这样会很耗时。因此在遇到没有记录的handler时，我们可以手动调用ql.os.stop()，这样ql_run_to_here可以为我们保存当前执行环境，之后我们仍然可以单步模拟执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># qilingida.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ql_run_to_here</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    userhook = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.userobj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        userhook = <span class="variable language_">self</span>.userobj.custom_run_to_here(<span class="variable language_">self</span>.qlemu.ql)</span><br><span class="line">    <span class="comment"># 当qlemu.run方法在模拟执行时，如果custom_run_to_here调用了ql.os.stop(),</span></span><br><span class="line">    <span class="comment"># 那么qlemu.run就会返回。</span></span><br><span class="line">    <span class="variable language_">self</span>.qlemu.run(end=curr_addr+<span class="variable language_">self</span>.qlemu.baseaddr-get_imagebase())</span><br><span class="line">    <span class="comment"># qlemu.run返回后保存当前模拟执行环境。</span></span><br><span class="line">    <span class="variable language_">self</span>.qlemu.status = <span class="variable language_">self</span>.qlemu.ql.save()</span><br><span class="line">            </span><br><span class="line"><span class="comment"># custom_script.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">custom_run_to_here</span>(<span class="params">self, ql: Qiling</span>) -&gt; <span class="type">List</span>[HookRet]:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">next_pc</span>(<span class="params">ql: Qiling, index = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">        next_pc = ql.arch.regs.X1 - <span class="number">0x555555554000</span></span><br><span class="line">        index = ql.arch.regs.X12 &amp; <span class="number">0x3F</span></span><br><span class="line">        rs = <span class="string">f&#x27;next unknown index: <span class="subst">&#123;index:#x&#125;</span> -&gt; &#x27;</span></span><br><span class="line">        ql.log.info(rs + <span class="string">f&#x27;next pc: <span class="subst">&#123;next_pc:#x&#125;</span>&#x27;</span>)</span><br><span class="line">        ql.os.stop()</span><br><span class="line">        <span class="keyword">global</span> log_flag</span><br><span class="line">        log_flag = <span class="literal">False</span></span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
<p>模拟执行的输出结果示例如下：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x48]</span> = <span class="comment">[func_data-0x48]</span> + 0xfea0; func_data-0x150, rs: func_data--0xfd50</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x158]</span> = <span class="comment">[func_data-0x38]</span>; func_data-0x158, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x150]</span> = <span class="comment">[func_data-0x80]</span>; func_data-0x160, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x148]</span> = <span class="comment">[func_data-0x88]</span>; func_data-0x168, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x140]</span> = <span class="comment">[func_data-0x90]</span>; func_data-0x170, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x138]</span> = <span class="comment">[func_data-0x98]</span>; func_data-0x178, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x130]</span> = <span class="comment">[func_data-0xa0]</span>; func_data-0x180, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x128]</span> = <span class="comment">[func_data-0xa8]</span>; func_data-0x188, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x120]</span> = <span class="comment">[func_data-0xb0]</span>; func_data-0x190, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0xb0]</span> = <span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x10]</span>; func_data-0x450 -&gt; func_data-0x440, 0x20</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0xa8]</span> = <span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x8]</span>; func_data-0x450 -&gt; func_data-0x448, 0x100000</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0x90]</span> = <span class="comment">[<span class="comment">[func_data-0x108]</span> + 0x0]</span>; 0x555555857110 -&gt; 0x555555857110, 0x555555f0abb0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x35 -&gt; <span class="comment">[func_data-0x88]</span> = (signed )d<span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x0]</span>; func_data-0x450, 0x555f9370</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[<span class="comment">[func_data-0x100]</span> + 0x0]</span>; 0x555555857118 -&gt; 0x555555857118, 0x555555cd9eb0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x98]</span> = d<span class="comment">[func_data-0x130]</span> + (int64)(int)0x0; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x110]</span> = b<span class="comment">[func_data-0x130]</span>; func_data-0x1a0, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0xa0]</span> = <span class="comment">[func_data-0x48]</span> + 0x4; func_data-0x2b0, rs: func_data-0x2ac</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x108]</span> = <span class="comment">[func_data-0xa0]</span>; func_data-0x1a8, func_data-0x2ac</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x130]</span> + 0x4; 0x0, rs: 0x4</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x118]</span> = <span class="comment">[func_data-0x120]</span>; func_data-0x198, 0x4</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x1f -&gt; <span class="comment">[func_data-0x120]</span> = int(0xff97 &lt;&lt; 0x10)</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x1d -&gt; <span class="comment">[func_data-0x80]</span> = <span class="comment">[func_data-0x120]</span> | 0x1488; 0xffffffffff970000, rs:0xffffffffff971488</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x110]</span> = <span class="comment">[func_data-0x80]</span> + <span class="comment">[func_data-0x128]</span>; 0xffffffffff971488, 0x555555cd9eb0, rs: 0x55555564b338</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x92b -&gt; <span class="comment">[func_data-0x68]</span> = <span class="comment">[func_data-0x130]</span> | <span class="comment">[func_data-0xf8]</span>; 0x0, 0x55555564b34c, rs: 0x55555564b34c</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xdeb -&gt; <span class="comment">[func_data-0x18]</span> = <span class="comment">[func_data-0x68]</span>; 0x55555564b34c</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line">						<span class="comment">[func_data-0x38]</span> = index_table_pointer+8; 0x5555557e5b90, rs: 0x5555557e5b98</span><br><span class="line">						<span class="comment">[func_data-0x10]</span> = index_table_pointer+8; 0x5555557e5b90, rs: 0x5555557e5b98</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x108]</span> = <span class="comment">[func_data-0x48]</span> + 0x108; func_data-0x2b0, rs: func_data-0x1a8</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x55555564b34c</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br><span class="line">						call func:(0x55555564b34c)(<span class="comment">[func_data-0x110]</span>, <span class="comment">[func_data-0x108]</span>); memset</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x10]</span>; 0x5555557e5b98</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x88]</span> &gt;&gt; 0x18; 0x555f9370, rs: 0x55</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x88]</span> &gt;&gt; 0x10; 0x555f9370, rs: 0x555f</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x118]</span> = d<span class="comment">[func_data-0x88]</span> &gt;&gt; 0x8; 0x555f9370, rs: 0x555f93</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x5]</span> = b<span class="comment">[func_data-0x118]</span>; func_data-0x2ab, 0x93</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x4]</span> = b<span class="comment">[func_data-0x88]</span>; func_data-0x2ac, 0x70</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x6]</span> = b<span class="comment">[func_data-0x120]</span>; func_data-0x2aa, 0x5f</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x7]</span> = b<span class="comment">[func_data-0x128]</span>; func_data-0x2a9, 0x55</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x118]</span> = <span class="comment">[func_data-0x80]</span> + <span class="comment">[func_data-0x90]</span>; 0xffffffffff971488, 0x555555f0abb0, rs: 0x55555587c038</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x38 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x98]</span> &lt; 0x100; 0x0, rs: 0x1</span><br></pre></td></tr></table></figure>

<h2 id="加解密算法分析"><a href="#加解密算法分析" class="headerlink" title="加解密算法分析"></a>加解密算法分析</h2><p>观察sub_F736C返回前，所有handler的执行记录，主要分为四部分：</p>
<blockquote>
<p>handler执行过程.txt已上传至附件，里面记录了整个执行流程。</p>
</blockquote>
<h3 id="环境初始化"><a href="#环境初始化" class="headerlink" title="环境初始化"></a>环境初始化</h3><p>虚拟栈的初始化已经sub_F736C的参数保存到虚拟栈：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x48]</span> = <span class="comment">[func_data-0x48]</span> + 0xfea0; func_data-0x150, rs: func_data--0xfd50</span><br><span class="line">//这里分号后面为自动生成的注释，表示从左到右，其内存的值。比如下面这一行，<span class="comment">[func_data-0x48]</span>的值是func_data-0x158；<span class="comment">[func_data-0x38]</span>的值是0。因为这是个写操作，就没有打印<span class="comment">[<span class="comment">[func_data-0x48]</span>+0x158]</span>的值了。</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x158]</span> = <span class="comment">[func_data-0x38]</span>; func_data-0x158, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x150]</span> = <span class="comment">[func_data-0x80]</span>; func_data-0x160, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x148]</span> = <span class="comment">[func_data-0x88]</span>; func_data-0x168, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x140]</span> = <span class="comment">[func_data-0x90]</span>; func_data-0x170, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x138]</span> = <span class="comment">[func_data-0x98]</span>; func_data-0x178, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x130]</span> = <span class="comment">[func_data-0xa0]</span>; func_data-0x180, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x128]</span> = <span class="comment">[func_data-0xa8]</span>; func_data-0x188, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x120]</span> = <span class="comment">[func_data-0xb0]</span>; func_data-0x190, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0xb0]</span> = <span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x10]</span>; func_data-0x450 -&gt; func_data-0x440, 0x20</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0xa8]</span> = <span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x8]</span>; func_data-0x450 -&gt; func_data-0x448, 0x100000</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0x90]</span> = <span class="comment">[<span class="comment">[func_data-0x108]</span> + 0x0]</span>; 0x555555857110 -&gt; 0x555555857110, 0x555555f0abb0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x35 -&gt; <span class="comment">[func_data-0x88]</span> = (signed )d<span class="comment">[<span class="comment">[func_data-0x110]</span> + 0x0]</span>; func_data-0x450, 0x555f9370</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x3c -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[<span class="comment">[func_data-0x100]</span> + 0x0]</span>; 0x555555857118 -&gt; 0x555555857118, 0x555555cd9eb0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x98]</span> = d<span class="comment">[func_data-0x130]</span> + (int64)(int)0x0; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x48]</span> + 0x110]</span> = b<span class="comment">[func_data-0x130]</span>; func_data-0x1a0, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0xa0]</span> = <span class="comment">[func_data-0x48]</span> + 0x4; func_data-0x2b0, rs: func_data-0x2ac</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x108]</span> = <span class="comment">[func_data-0xa0]</span>; func_data-0x1a8, func_data-0x2ac</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x130]</span> + 0x4; 0x0, rs: 0x4</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x29 -&gt; <span class="comment">[<span class="comment">[func_data-0x48]</span>+0x118]</span> = <span class="comment">[func_data-0x120]</span>; func_data-0x198, 0x4</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x1f -&gt; <span class="comment">[func_data-0x120]</span> = int(0xff97 &lt;&lt; 0x10)</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x1d -&gt; <span class="comment">[func_data-0x80]</span> = <span class="comment">[func_data-0x120]</span> | 0x1488; 0xffffffffff970000, rs:0xffffffffff971488</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x110]</span> = <span class="comment">[func_data-0x80]</span> + <span class="comment">[func_data-0x128]</span>; 0xffffffffff971488, 0x555555cd9eb0, rs: 0x55555564b338</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x92b -&gt; <span class="comment">[func_data-0x68]</span> = <span class="comment">[func_data-0x130]</span> | <span class="comment">[func_data-0xf8]</span>; 0x0, 0x55555564b34c, rs: 0x55555564b34c</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xdeb -&gt; <span class="comment">[func_data-0x18]</span> = <span class="comment">[func_data-0x68]</span>; 0x55555564b34c</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line">						<span class="comment">[func_data-0x38]</span> = index_table_pointer+8; 0x5555557e5b90, rs: 0x5555557e5b98</span><br><span class="line">						<span class="comment">[func_data-0x10]</span> = index_table_pointer+8; 0x5555557e5b90, rs: 0x5555557e5b98</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x108]</span> = <span class="comment">[func_data-0x48]</span> + 0x108; func_data-0x2b0, rs: func_data-0x1a8</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x55555564b34c</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br><span class="line">						call func:(0x55555564b34c)(<span class="comment">[func_data-0x110]</span>, <span class="comment">[func_data-0x108]</span>); memset</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x10]</span>; 0x5555557e5b98</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br></pre></td></tr></table></figure>

<h3 id="准备一个256字节大小的S-box表"><a href="#准备一个256字节大小的S-box表" class="headerlink" title="准备一个256字节大小的S-box表"></a>准备一个256字节大小的S-box表</h3><p>读取[func_data-0x98]的一个字节，赋值给func_data-0x2a8地址处，同时[func_data-0x98]和[func_data-0x120]都自增1，直到[func_data-0x98]&#x3D;&#x3D;0x100。</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x120]</span> + 0x0]</span> = b<span class="comment">[func_data-0x98]</span>; func_data-0x2a8, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x98]</span> = d<span class="comment">[func_data-0x98]</span> + (int64)(int)0x1; 0x0, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x38 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x98]</span> &lt; 0x100; 0x1, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">						<span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">						<span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xfffc &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5bd0</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x120]</span> + 0x1; func_data-0x2a8, rs: func_data-0x2a7</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5bc4</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x120]</span> + 0x0]</span> = b<span class="comment">[func_data-0x98]</span>; func_data-0x2a7, 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x98]</span> = d<span class="comment">[func_data-0x98]</span> + (int64)(int)0x1; 0x1, rs: 0x2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x38 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x98]</span> &lt; 0x100; 0x2, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">						<span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">						<span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xfffc &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5bd0</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x120]</span> + 0x1; func_data-0x2a7, rs: func_data-0x2a6</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5bc4</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x120]</span> + 0x0]</span> = b<span class="comment">[func_data-0x98]</span>; func_data-0x2a6, 0x2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x98]</span> = d<span class="comment">[func_data-0x98]</span> + (int64)(int)0x1; 0x2, rs: 0x3</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x38 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x98]</span> &lt; 0x100; 0x3, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">						<span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">						<span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xfffc &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5bd0</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x120]</span> + 0x1; func_data-0x2a6, rs: func_data-0x2a5</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5bc4</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br></pre></td></tr></table></figure>

<p>以上逻辑用C++实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SHUFFLE_TABLE_LEN 256</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> shuffle_table[SHUFFLE_TABLE_LEN] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SHUFFLE_TABLE_LEN; ++i)</span><br><span class="line">    shuffle_table[i] = i;</span><br></pre></td></tr></table></figure>

<h3 id="S-box表置换"><a href="#S-box表置换" class="headerlink" title="S-box表置换"></a>S-box表置换</h3><p>遍历S-box表，i从0自增到255：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">//读取S-box表的第i个元素 a</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x72b -&gt; <span class="comment">[func_data-0x128]</span> = (int)d<span class="comment">[func_data-0x120]</span> &gt;&gt; 0x1f; 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0xe0]</span> = d<span class="comment">[func_data-0x128]</span> &gt;&gt; 0x1b; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0xe0]</span> = d<span class="comment">[func_data-0xe0]</span> + d<span class="comment">[func_data-0x120]</span>; 0x0, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9eb -&gt; <span class="comment">[func_data-0xe0]</span> = <span class="comment">[func_data-0x108]</span> &amp; <span class="comment">[func_data-0xe0]</span>; 0xffffffffffffffe0, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xb2b -&gt; <span class="comment">[func_data-0xe0]</span> = d<span class="comment">[func_data-0x120]</span> - d<span class="comment">[func_data-0xe0]</span>; 0x0, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0xe0]</span> = d<span class="comment">[func_data-0xe0]</span> &lt;&lt; 0x0; 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0xd8]</span> = <span class="comment">[func_data-0xf0]</span> + 0x1; func_data-0x2a8, rs: func_data-0x2a7</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0xd0]</span> = b<span class="comment">[<span class="comment">[func_data-0xf0]</span> + 0x0]</span>; func_data-0x2a8, 0x0</span><br><span class="line"></span><br><span class="line">// S-box表的第i个元素和上一轮结果相加：a+last_result</span><br><span class="line">// last_result初始化为0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0xd0]</span> + d<span class="comment">[func_data-0xe8]</span>; 0x0, 0x0, rs: 0x0</span><br><span class="line"></span><br><span class="line">// <span class="comment">[func_data-0x118]</span>是sub_F736C函数的第3个参数，是一个0x20字节的数组，元素长度为1，这里命名为shuffle_factor_table。</span><br><span class="line">// 从shuffle_factor_table取(i%0x20)，然后与上一步相加：</span><br><span class="line">// 得 a+last_result+shuffle_factor_table<span class="comment">[i%0x20]</span></span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0xc8]</span> = d<span class="comment">[func_data-0x120]</span> + (int64)(int)0x1; 0x0, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x128]</span> &gt;&gt; 0x1e; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0xe0]</span> = <span class="comment">[func_data-0xe0]</span> + <span class="comment">[func_data-0x118]</span>; 0x0, 0x55555587c038, rs: 0x55555587c038</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0xe0]</span> = b<span class="comment">[<span class="comment">[func_data-0xe0]</span> + 0x0]</span>; 0x55555587c038, 0x48</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0xe0]</span> + d<span class="comment">[func_data-0xe8]</span>; 0x48, 0x0, rs: 0x48</span><br><span class="line"></span><br><span class="line">// tps_encrypt和tps_decrypt的第一个参数serino，小端序保存在内存中，然后取出一字节与上一步相加：</span><br><span class="line">// 地 a+last_result+shuffle_factor_table<span class="comment">[i%0x20]</span>+serino<span class="comment">[i%4]</span></span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x128]</span> + d<span class="comment">[func_data-0x120]</span>; 0x0, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9eb -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0xf8]</span> &amp; <span class="comment">[func_data-0x128]</span>; 0xfffffffffffffffc, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xb2b -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x120]</span> - d<span class="comment">[func_data-0x128]</span>; 0x0, 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x128]</span> &lt;&lt; 0x0; 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> + <span class="comment">[func_data-0xa0]</span>; 0x0, func_data-0x2ac, rs: func_data-0x2ac</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0x128]</span> = b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span>; func_data-0x2ac, 0x70</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x128]</span> + d<span class="comment">[func_data-0xe8]</span>; 0x70, 0x48, rs: 0xb8</span><br><span class="line"></span><br><span class="line">// 上一步结果与0xFF求余</span><br><span class="line">// 得 last_result = (a+last_result+shuffle_factor_table<span class="comment">[i%0x20]</span>+serino<span class="comment">[i%4]</span>) &amp; 0xFF</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x72b -&gt; <span class="comment">[func_data-0x120]</span> = (int)d<span class="comment">[func_data-0x128]</span> &gt;&gt; 0x1f; 0xb8</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x120]</span> &gt;&gt; 0x18; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x120]</span> + d<span class="comment">[func_data-0x128]</span>; 0x0, 0xb8, rs: 0xb8</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9eb -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x100]</span> &amp; <span class="comment">[func_data-0x120]</span>; 0xffffffffffffff00, 0xb8, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xb2b -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0x128]</span> - d<span class="comment">[func_data-0x120]</span>; 0xb8, 0x0, rs: 0xb8</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0xe8]</span> &lt;&lt; 0x0; 0xb8</span><br><span class="line"></span><br><span class="line">// S-box表置换</span><br><span class="line">// tmp = S-box<span class="comment">[i]</span></span><br><span class="line">// S-box<span class="comment">[i]</span> = S-box<span class="comment">[last_result]</span></span><br><span class="line">// S-box<span class="comment">[last_result]</span> = tmp</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> + <span class="comment">[func_data-0x110]</span>; 0xb8, func_data-0x2a8, rs: func_data-0x1f0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0x120]</span> = b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span>; func_data-0x1f0, 0xb8</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0xf0]</span> + 0x0]</span> = b<span class="comment">[func_data-0x120]</span>; func_data-0x2a8, 0xb8</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span> = b<span class="comment">[func_data-0xd0]</span>; func_data-0x1f0, 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x92b -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x130]</span> | <span class="comment">[func_data-0xc8]</span>; 0x0, 0x1, rs: 0x1</span><br><span class="line"></span><br><span class="line">// 没有遍历到0x256，回调到S-box置换的第一条指令，继续置换</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x38 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x120]</span> &lt; 0x100; 0x1, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">						<span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">						<span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xffde &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5c80</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x92b -&gt; <span class="comment">[func_data-0xf0]</span> = <span class="comment">[func_data-0x130]</span> | <span class="comment">[func_data-0xd8]</span>; 0x0, 0x80000000db39, rs: func_data-0x2a7</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5bfc</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br></pre></td></tr></table></figure>

<p>以上逻辑用C++实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Fisher_Yates</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> shuffle_table[SHUFFLE_TABLE_LEN], <span class="type">unsigned</span> <span class="type">int</span> serino)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> shuffle_factor_table[SHUFFLE_FACTOR_TABLE_LEN] = &#123; </span><br><span class="line">        <span class="number">0x48</span>, <span class="number">0xA9</span>, <span class="number">0xC8</span>, <span class="number">0x12</span>, <span class="number">0xCA</span>, <span class="number">0xFC</span>, <span class="number">0xD3</span>, <span class="number">0x5E</span>, <span class="number">0xB7</span>, <span class="number">0x61</span>, <span class="number">0x50</span>, <span class="number">0x17</span>, <span class="number">0x68</span>, <span class="number">0xBA</span>, <span class="number">0x7E</span>, <span class="number">0x2E</span>, </span><br><span class="line">        <span class="number">0xB9</span>, <span class="number">0xA2</span>, <span class="number">0x38</span>, <span class="number">0x85</span>, <span class="number">0x35</span>, <span class="number">0x48</span>, <span class="number">0x55</span>, <span class="number">0x6C</span>, <span class="number">0x2C</span>, <span class="number">0x38</span>, <span class="number">0x43</span>, <span class="number">0x1F</span>, <span class="number">0x51</span>, <span class="number">0xD6</span>, <span class="number">0x30</span>, <span class="number">0x30</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> last_result = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> serino_table[] = &#123; serino &amp; <span class="number">0xFF</span>, (serino &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, (serino &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (serino &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SHUFFLE_TABLE_LEN; ++i) &#123;</span><br><span class="line">        last_result = (shuffle_factor_table[i % SHUFFLE_FACTOR_TABLE_LEN] + shuffle_table[i] + last_result + serino_table[i % <span class="number">4</span>]) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> tmp = shuffle_table[i];</span><br><span class="line">        shuffle_table[i] = shuffle_table[last_result];</span><br><span class="line">        shuffle_table[last_result] = tmp;</span><br><span class="line">        <span class="comment">//printf(&quot;exchange: %x -&gt; %x, factor: %x\n&quot;, i, last_result, shuffle_factor_table[i%SHUFFLE_FACTOR_TABLE_LEN]);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据加解密"><a href="#数据加解密" class="headerlink" title="数据加解密"></a>数据加解密</h3><p>遍历待加解密的数据，i从0到len(data)-1</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">// a = (i+1) &amp; 0xFF</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2d -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x120]</span> + (int64)(int)0x1; 0x100, rs: 0x101</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x72b -&gt; <span class="comment">[func_data-0x120]</span> = (int)d<span class="comment">[func_data-0x128]</span> &gt;&gt; 0x1f; 0x101</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x120]</span> &gt;&gt; 0x18; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x120]</span> + d<span class="comment">[func_data-0x128]</span>; 0x0, 0x101, rs: 0x101</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9eb -&gt; <span class="comment">[func_data-0x120]</span> = <span class="comment">[func_data-0x118]</span> &amp; <span class="comment">[func_data-0x120]</span>; 0xffffffffffffff00, 0x101, rs: 0x100</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xb2b -&gt; <span class="comment">[func_data-0x120]</span> = d<span class="comment">[func_data-0x128]</span> - d<span class="comment">[func_data-0x120]</span>; 0x101, 0x100, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0x120]</span> &lt;&lt; 0x0; 0x1</span><br><span class="line"></span><br><span class="line">// func_data-0xa8为待加解密的数据，这里命名为x</span><br><span class="line">// 保存当前的字节x<span class="comment">[i]</span>到<span class="comment">[func_data-0x100]</span></span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9 -&gt; <span class="comment">[func_data-0xf8]</span> = <span class="comment">[func_data-0x100]</span> + 0x1; 0x0, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x100]</span> = <span class="comment">[func_data-0x100]</span> + <span class="comment">[func_data-0xa8]</span>; 0x0, 0x100000, rs: 0x100000</span><br><span class="line"></span><br><span class="line">// func_data-0x110保存着S-box的地址</span><br><span class="line">// 从置换后的S-box取出一字节，index为a，并与上一轮结果相加</span><br><span class="line">// 得b = S-box<span class="comment">[a]</span>+last_result</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> + <span class="comment">[func_data-0x110]</span>; 0x1, func_data-0x2a8, rs: func_data-0x2a7</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0xf0]</span> = b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span>; func_data-0x2a7, 0xa9</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x108]</span> = d<span class="comment">[func_data-0xf0]</span> + d<span class="comment">[func_data-0x108]</span>; 0xa9, 0x0, rs: 0xa9</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x72b -&gt; <span class="comment">[func_data-0xe8]</span> = (int)d<span class="comment">[func_data-0x108]</span> &gt;&gt; 0x1f; 0xa9</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xa6b -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0xe8]</span> &gt;&gt; 0x18; 0x0, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0xe8]</span> + d<span class="comment">[func_data-0x108]</span>; 0x0, 0xa9, rs: 0xa9</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x9eb -&gt; <span class="comment">[func_data-0xe8]</span> = <span class="comment">[func_data-0x118]</span> &amp; <span class="comment">[func_data-0xe8]</span>; 0xffffffffffffff00, 0xa9, rs: 0x0</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xb2b -&gt; <span class="comment">[func_data-0x108]</span> = d<span class="comment">[func_data-0x108]</span> - d<span class="comment">[func_data-0xe8]</span>; 0xa9, 0x0, rs: 0xa9</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0xe8]</span> = d<span class="comment">[func_data-0x108]</span> &lt;&lt; 0x0; 0xa9</span><br><span class="line"></span><br><span class="line">// S-box表置换</span><br><span class="line">// tmp = S-box<span class="comment">[a]</span></span><br><span class="line">// S-box<span class="comment">[a]</span> = S-box<span class="comment">[b]</span></span><br><span class="line">// S-box<span class="comment">[b]</span> = S-box<span class="comment">[a]</span></span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0xe8]</span> = <span class="comment">[func_data-0xe8]</span> + <span class="comment">[func_data-0x110]</span>; 0xa9, func_data-0x2a8, rs: func_data-0x1ff</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0xe0]</span> = b<span class="comment">[<span class="comment">[func_data-0xe8]</span> + 0x0]</span>; func_data-0x1ff, 0xc1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span> = b<span class="comment">[func_data-0xe0]</span>; func_data-0x2a7, 0xc1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0xe8]</span> + 0x0]</span> = b<span class="comment">[func_data-0xf0]</span>; func_data-0x1ff, 0xa9</span><br><span class="line"></span><br><span class="line">// x<span class="comment">[i]</span> = x<span class="comment">[i]</span> ^ ((S-box<span class="comment">[a]</span> + tmp) &amp; 0xFF)</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0x128]</span> = b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span>; func_data-0x2a7, 0xc1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xcab -&gt; <span class="comment">[func_data-0x128]</span> = d<span class="comment">[func_data-0xf0]</span> + d<span class="comment">[func_data-0x128]</span>; 0xa9, 0xc1, rs: 0x16a</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0xf0]</span> = b<span class="comment">[<span class="comment">[func_data-0x100]</span> + 0x0]</span>; 0x100000, 0x12</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x37 -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> &amp; 0xff; 0x16a, rs:0x6a</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x7 -&gt; <span class="comment">[func_data-0x128]</span> = ((1(LL) &lt;&lt; (W10+1)) - 1) &amp; (<span class="comment">[func_data-0x128]</span> &gt;&gt; W11); 0x1f, 0x6a, 0x0, rs: 0x6a</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0xc2b -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> + <span class="comment">[func_data-0x110]</span>; 0x6a, func_data-0x2a8, rs: func_data-0x23e</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x30 -&gt; <span class="comment">[func_data-0x128]</span> = b<span class="comment">[<span class="comment">[func_data-0x128]</span> + 0x0]</span>; func_data-0x23e, 0xef</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x36b -&gt; <span class="comment">[func_data-0x128]</span> = <span class="comment">[func_data-0x128]</span> ^ <span class="comment">[func_data-0xf0]</span>; 0xef, 0x12, rs: 0xfd</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x2a -&gt; b<span class="comment">[<span class="comment">[func_data-0x100]</span> + 0x0]</span> = b<span class="comment">[func_data-0x128]</span>; 0x100000, 0xfd</span><br><span class="line"></span><br><span class="line">// 没有遍历到x的长度，继续遍历</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x92b -&gt; <span class="comment">[func_data-0x100]</span> = <span class="comment">[func_data-0x130]</span> | <span class="comment">[func_data-0xf8]</span>; 0x0, 0x1, rs: 0x1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x1eb -&gt; base_W9_value &lt; base_W8_value: <span class="comment">[func_data-0x128]</span> = 1; w8=<span class="comment">[func_data-0xb0]</span>=32, w9=<span class="comment">[func_data-0x100]</span>=1</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x34 -&gt; <span class="comment">[func_data-0x130]</span>; 0x0</span><br><span class="line">						<span class="comment">[func_data-0x128]</span>; 0x1</span><br><span class="line">						<span class="comment">[func_data-0x18]</span> = index_table_pointer+4+((int)(0xffde &lt;&lt; 0x10) &gt;&gt; 0xE); 0x5555557e5d24</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 2</span><br><span class="line"><span class="comment">[=]</span> <span class="comment">[Thread 2008]</span>	index: 0x4ab -&gt; <span class="comment">[func_data-0x130]</span> = d<span class="comment">[func_data-0x130]</span> &lt;&lt; 0x0; 0x0</span><br><span class="line">						index_table_pointer = <span class="comment">[func_data-0x18]</span>; 0x5555557e5ca0</span><br><span class="line">						<span class="comment">[func_data-0x20]</span> = 0</span><br><span class="line">						<span class="comment">[beg]</span> = index_table_pointer</span><br></pre></td></tr></table></figure>

<p>以上逻辑用C++实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt_and_decrypt_data</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> shuffle_table[SHUFFLE_TABLE_LEN], <span class="type">unsigned</span> <span class="type">char</span>* x, <span class="type">int</span> len)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> last_result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> s_i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> cur = shuffle_table[s_i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// last_result = (last_result + cur) &amp; 0xFF;</span></span><br><span class="line">        last_result += cur; <span class="comment">// no need to &#x27;and 0xFF&#x27;, because the type of last_result is unsigned char</span></span><br><span class="line"></span><br><span class="line">        shuffle_table[s_i] = shuffle_table[last_result];</span><br><span class="line">        shuffle_table[last_result] = cur;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> tmp = (cur + shuffle_table[s_i]) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        x[i] = x[i] ^ shuffle_table[tmp];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>第一次使用qiling来做模拟执行，踩了不少坑。不过这些坑填完了，之后模拟执行就会方便很多。</p>
<p>libxx.so的加解密算法很简单，相信大家已经能看出来这个是RC4，不过稍微有一点魔改，把密钥分成了两部分。</p>
<p>加解密算法的保护主要还是通过虚拟机来实现的，其中也有一点花指令和动态字符串解密，不过这些在libxx.so里都很简单，所以没有细说。</p>
<p>希望本文可以给想用qiling做模拟执行的朋友一些提示，快速过掉qiling的一些坑。</p>

      <div class="tags">
          <a href="/tags/Android/" rel="tag"><i class="ic i-tag"></i> Android</a>
          <a href="/tags/qiling/" rel="tag"><i class="ic i-tag"></i> qiling</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2025-03-08 12:09:36" itemprop="dateModified" datetime="2025-03-08T12:09:36+08:00">2025-03-08</time>
  </span>
  <span id="Technology/Reverse/aarch64架构的某so模拟执行和加密算法分析/" class="item leancloud_visitors" data-flag-title="aarch64架构的某so模拟执行分析" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>coneco <i class="ic i-at"><em>@</em></i>Welcome to coneco's study room
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://conecoy.cn/Technology/Reverse/aarch64%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9F%90so%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%92%8C%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/" title="aarch64架构的某so模拟执行分析">https://conecoy.cn/Technology/Reverse/aarch64架构的某so模拟执行和加密算法分析/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/Technology/Reverse/%E5%85%B3%E4%BA%8EVS%E7%82%B9%E5%87%BB%E5%8D%95%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%8D%A1%E6%AD%BB%E7%9A%84%E5%88%86%E6%9E%90/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;image-hosts.oss-cn-chengdu.aliyuncs.com&#x2F;aokana&#x2F;72.jpg" title="关于VS点击单个测试用例卡死的分析">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> Reverse</span>
  <h3>关于VS点击单个测试用例卡死的分析</h3>
  </a>

    </div>
    <div class="item right">
    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E6%96%87%E7%9B%AE%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text">本文目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">分析目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">3.</span> <span class="toc-text">选择模拟执行的原因</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90%E6%88%90%E6%9C%AC%E8%BF%87%E9%AB%98"><span class="toc-number">3.1.</span> <span class="toc-text">静态分析成本过高</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E8%B0%83%E8%AF%95%E5%99%A8%E8%B0%83%E8%AF%95"><span class="toc-number">3.2.</span> <span class="toc-text">用调试器调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C"><span class="toc-number">3.3.</span> <span class="toc-text">模拟执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ARM64-demo%E8%BF%90%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">ARM64 demo运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96qiling%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.</span> <span class="toc-text">初始化qiling环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C"><span class="toc-number">4.2.</span> <span class="toc-text">开始模拟执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%98%BE%E5%BC%8F%E8%AE%BE%E7%BD%AEPC%E5%AF%84%E5%AD%98%E5%99%A8%E6%8C%87%E5%AE%9A%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E5%85%A5%E5%8F%A3"><span class="toc-number">4.3.</span> <span class="toc-text">通过显式设置PC寄存器指定程序执行入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E8%8A%82"><span class="toc-number">4.4.</span> <span class="toc-text">小节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#libxx-so%E7%9A%84%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%EF%BC%88%E6%8E%92%E9%94%99%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">libxx.so的模拟执行（排错）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A1%86%E6%9E%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">虚拟机框架解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%AE%80%E8%A6%81%E6%B5%81%E7%A8%8B"><span class="toc-number">6.1.</span> <span class="toc-text">虚拟机的简要流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BB%93%E6%9E%84%E5%89%96%E6%9E%90"><span class="toc-number">6.2.</span> <span class="toc-text">虚拟机结构剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="toc-number">6.3.</span> <span class="toc-text">虚拟机执行流程解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">加解密算法分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">7.1.</span> <span class="toc-text">环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%80%E4%B8%AA256%E5%AD%97%E8%8A%82%E5%A4%A7%E5%B0%8F%E7%9A%84S-box%E8%A1%A8"><span class="toc-number">7.2.</span> <span class="toc-text">准备一个256字节大小的S-box表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#S-box%E8%A1%A8%E7%BD%AE%E6%8D%A2"><span class="toc-number">7.3.</span> <span class="toc-text">S-box表置换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-number">7.4.</span> <span class="toc-text">数据加解密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/Technology/Reverse/StackUnwind/" rel="bookmark" title="StackUnwind">StackUnwind</a></li><li><a href="/Technology/Reverse/VMP-anti-vmware/" rel="bookmark" title="浅谈VMP、SafeEngine、Themida反虚拟机">浅谈VMP、SafeEngine、Themida反虚拟机</a></li><li><a href="/Technology/Reverse/Mechanism-of-LFH/" rel="bookmark" title="Mechanism_of_LFH">Mechanism_of_LFH</a></li><li><a href="/Technology/Reverse/Microsoft-Defender-ATP-ETW/" rel="bookmark" title="[翻译] Microsoft Defender ATP ETW">[翻译] Microsoft Defender ATP ETW</a></li><li><a href="/Technology/Reverse/Process-Injection/" rel="bookmark" title="Process_Injection">Process_Injection</a></li><li><a href="/Technology/Reverse/%E5%85%B3%E4%BA%8EVS%E7%82%B9%E5%87%BB%E5%8D%95%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%8D%A1%E6%AD%BB%E7%9A%84%E5%88%86%E6%9E%90/" rel="bookmark" title="关于VS点击单个测试用例卡死的分析">关于VS点击单个测试用例卡死的分析</a></li><li class="active"><a href="/Technology/Reverse/aarch64%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9F%90so%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%92%8C%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/" rel="bookmark" title="aarch64架构的某so模拟执行分析">aarch64架构的某so模拟执行分析</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="coneco"
      data-src="https://image-hosts.oss-cn-chengdu.aliyuncs.com/others/megumi.jpg">
  <p class="name" itemprop="name">coneco</p>
  <div class="description" itemprop="description">hello, 我是小猫，喜欢逆向、日语、动画、钢琴、羽毛球、乒乓球...。如果有想分享的事，欢迎随便叫上我^_^。</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">20</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">5</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">40</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NvLW5lY28=" title="https:&#x2F;&#x2F;github.com&#x2F;co-neco"><i class="ic i-github"></i></span>
      <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS8xMDczMzUyMzM0" title="https:&#x2F;&#x2F;twitter.com&#x2F;1073352334"><i class="ic i-twitter"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE3NDYyMzM5MDg=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1746233908"><i class="ic i-cloud-music"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/c++%E7%BC%96%E7%A8%8B%E9%94%99%E8%AF%AF%E9%94%A6%E5%9B%8A/" title="c++编程错误锦囊">c++编程错误锦囊</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/C++%E5%B7%A5%E7%A8%8B%E9%A2%84%E7%BC%96%E8%AF%91%E7%AC%94%E8%AE%B0/" title="C++工程预编译笔记.md">C++工程预编译笔记.md</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Reverse/" title="分类于 Reverse">Reverse</a>
</div>

    <span><a href="/Technology/Reverse/%E5%85%B3%E4%BA%8EVS%E7%82%B9%E5%87%BB%E5%8D%95%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%8D%A1%E6%AD%BB%E7%9A%84%E5%88%86%E6%9E%90/" title="关于VS点击单个测试用例卡死的分析">关于VS点击单个测试用例卡死的分析</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Obfuscation/" title="分类于 Obfuscation">Obfuscation</a>
</div>

    <span><a href="/Technology/Obfuscation/%E6%B7%B7%E6%B7%86%E7%AE%80%E4%BB%8B/" title="混淆简介">混淆简介</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/Study-of-C-Coding-Standards/" title="Study of C++ Coding Standards">Study of C++ Coding Standards</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Reverse/" title="分类于 Reverse">Reverse</a>
</div>

    <span><a href="/Technology/Reverse/Microsoft-Defender-ATP-ETW/" title="[翻译] Microsoft Defender ATP ETW">[翻译] Microsoft Defender ATP ETW</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/runtime%E8%BF%90%E8%A1%8C%E6%97%B6%E5%BA%93%E5%9C%A8MT%E4%B8%8EMD%E4%B9%8B%E9%97%B4%E7%9A%84%E5%B7%AE%E5%88%AB/" title="runtime运行时库在MT与MD之间的差别">runtime运行时库在MT与MD之间的差别</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/C++%E5%AE%89%E5%85%A8%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83%E7%AC%94%E8%AE%B0/" title="C++安全编程规范笔记">C++安全编程规范笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Reverse/" title="分类于 Reverse">Reverse</a>
</div>

    <span><a href="/Technology/Reverse/aarch64%E6%9E%B6%E6%9E%84%E7%9A%84%E6%9F%90so%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C%E5%92%8C%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/" title="aarch64架构的某so模拟执行分析">aarch64架构的某so模拟执行分析</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Technology/" title="分类于 Technology">Technology</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Technology/Development/" title="分类于 Development">Development</a>
</div>

    <span><a href="/Technology/Development/COM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="COM学习笔记">COM学习笔记</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2021 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">coneco </span>
    <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">蜀ICP备2021022030号-1</a> 
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'Technology/Reverse/aarch64架构的某so模拟执行和加密算法分析/',
    favicon: {
      show: "（^_^) Coneco's diary",
      hide: "（^_^) お帰り"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://polyfill.alicdn.com/polyfill.min.js"></script>

<script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
